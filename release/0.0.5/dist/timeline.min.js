/*
Copyright (c) 2019 
name: @scenejs/timeline
license: ISC
author: 
repository: git+https://github.com/daybrush/scenejs-timeline.git
version: 0.0.5
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@daybrush/utils"),require("@daybrush/drag"),require("@egjs/axes")):"function"==typeof define&&define.amd?define(["@daybrush/utils","@daybrush/drag","@egjs/axes"],t):(e=e||self).Timeline=t(e.utils,e.utils,e.eg.Axes)}(this,function(y,r,i){"use strict";var f="scenejs_timeline_",v='\n.timeline {\n  position: relative;\n  font-size: 0;\n  background: #000;\n  display: flex;\n  flex-direction: column;\n}\n.header_area, .scroll_area {\n   width: 100%;\n   position: relative;\n  display: flex;\n  -webkit-align-items: flex-start;\n  align-items: flex-start;\n}\n.header_area {\n  position: relative;\n  z-index: 10;\n  top: 0;\n  height: 30px;\n  min-height: 30px;\n}\n.header_area .keyframes {\n  padding: 0px;\n}\n.header_area .properties_area,\n.header_area .keyframes_area,\n.header_area .values_area,\n.header_area .keyframes_scroll_area {\n    height: 100%;\n}\n.header_area .property, .header_area .value, .header_area .keyframes {\n  height: 100%;\n}\n.header_area .property {\n    line-height: 30px;\n}\n.header_area .value {\n    text-align: center;\n    color: #fff;\n    line-height: 30px;\n    font-weight: bold;\n    font-size: 20px;\n}\n.header_area .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.header_area .keyframe_cursor {\n    position: absolute;\n    border-top: 10px solid #f55;\n    border-left: 5px solid transparent;\n    border-right: 5px solid transparent;\n    width: 0;\n    height: 0;\n    bottom: 0;\n    top: auto;\n    background: none;\n    cursor: pointer;\n}\n.control_area .keyframes {\n    padding-left: 10px;\n}\n.play_control_area {\n    position: absolute;\n    top: 0;\n    left: 50%;\n    transform: translate(-50%);\n}\n.play_control_area .control {\n    display: inline-block;\n    color: white;\n    margin: 0px 10px;\n}\n.keytime {\n  position: relative;\n  display: inline-block;\n  height: 100%;\n  font-size: 13px;\n  font-weight: bold;\n  color: #777;\n}\n.keytime:last-child {\n  max-width: 0px;\n}\n.keytime span {\n  position: absolute;\n  top: 2px;\n  left: 0;\n  display: inline-block;\n  transform: translate(-50%);\n  color: #eee;\n}\n.keytime .graduation {\n  position: absolute;\n  bottom: 0;\n  width: 1px;\n  height: 10px;\n  background: #777;\n  transform: translate(-50%);\n}\n.keytime .graduation.half {\n  left: 50%;\n  height: 7px;\n}\n.keytime .graduation.quarter {\n  left: 25%;\n  height: 5px;\n}\n.keytime .graduation.quarter3 {\n  left: 75%;\n  height: 5px;\n}\n.scroll_area {\n  position: relative;\n  width: 100%;\n  height: calc(100% - 60px);\n  overflow: auto;\n}\n.properties_area, .keyframes_area, .values_area {\n  display: inline-block;\n  position: relative;\n  font-size: 16px;\n  overflow: auto;\n}\n\n.properties_area::-webkit-scrollbar, .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.properties_area {\n  width: 30%;\n  max-width: 200px;\n  box-sizing: border-box;\n}\n.values_area {\n    width: 50px;\n    min-width: 50px;\n    display: inline-block;\n    border-right: 1px solid #999;\n    box-sizing: border-box;\n}\n.value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #fe5;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n    text-align: center;\n}\n.value[data-object="1"] input {\n    display: none;\n}\n.properties_scroll_area {\n  display: inline-block;\n  min-width: 100%;\n}\n.keyframes_area {\n  flex: 1;\n}\n.keyframes_scroll_area {\n  position: relative;\n  min-width: 300px;\n}\n.keyframes, .property, .value {\n  position: relative;\n  height: 25px;\n  border-bottom: 1px solid #777;\n  box-sizing: border-box;\n  white-space: nowrap;\n  background: rgba(90, 90, 90, 0.7);\n  z-index: 1;\n}\n\n.property {\n  line-height: 25px;\n  padding-left: 10px;\n  box-sizing: border-box;\n  font-size: 13px;\n  font-weight: bold;\n  color: #eee;\n}\n.time_area {\n    font-size: 13px;\n    color: #fe5;\n    line-height: 30px;\n    font-weight: bold;\n}\n.time_area:after {\n    content: "s";\n}\n.property .arrow {\n    position: relative;\n    display: inline-block;\n    margin-right: 5px;\n    width: 0;\n    vertical-align: middle;\n    cursor: pointer;\n    border-top: 6px solid #eee;\n    border-left: 4px solid transparent;\n    border-right: 4px solid transparent;\n}\n.property[data-fold="1"] .arrow {\n    border-top: 4px solid transparent;\n    border-bottom: 4px solid transparent;\n    border-right: 0;\n    border-left: 6px solid #eee;\n    margin-left: 2px;\n}\n.property[data-object="0"] .arrow {\n    display: none;\n}\n.property.fold, .keyframes.fold, .value.fold {\n    display: none;\n}\n.property.select, .value.select, .keyframes.select {\n    background: rgba(120, 120, 120, 0.7);\n}\n.keyframes {\n\n}\n.keyframe_line {\n  position: absolute;\n  height: 8px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  background: #aaa;\n  z-index: 0;\n}\n.keyframe {\n  position: absolute;\n  font-size: 0px;\n  width: 12px;\n  height: 12px;\n  top: 0px;\n  bottom: 0px;\n  margin: auto;\n  background: #fff;\n  border: 2px solid #383838;\n  border-radius: 2px;\n  box-sizing: border-box;\n  transform: translate(-50%) rotate(45deg);\n  z-index: 1;\n  cursor: pointer;\n}\n.select .keyframe {\n    border-color: #4d4d4d;\n}\n.keyframes_container, .line_area {\n  position: relative;\n  width: calc(100% - 30px);\n  left: 15px;\n  height: 100%;\n}\n.line_area {\n  position: absolute;\n  top: 0;\n  z-index: 0;\n}\n.keyframe_cursor {\n  position: absolute;\n  top: 0;\n  z-index: 1;\n  background: #f55;\n  width: 1px;\n  height: 100%;\n  left: 15px;\n  transform: translate(-50%);\n}\n.division_line {\n  position: absolute;\n  background: #333;\n  width: 1px;\n  height: 100%;\n  transform: translate(-50%);\n}\n'.replace(/\.([^{,\s\d.]+)/g,"."+f+"$1");function p(e,t){for(var n in t)e.style[n]=t[n]}function c(t){return"object"==typeof t?Array.isArray(t)?"["+t.join(", ")+"]":"{"+function(e){var t=[];for(var n in e)t.push(n);return t}(t).map(function(e){return e+": "+c(t[e])}).join(", ")+"}":t}function h(e,t){for(var n=e;n&&n!==document.body;){if(t(n))return n;n=n.parentNode}return null}function m(e,t){return y.hasClass(e,""+f+t)}function g(e,t){return y.addClass(e,""+f+t)}function b(e,t){return y.removeClass(e,""+f+t)}function x(a,e,t){void 0===t&&(t={structures:{},elements:{},element:null});var n=a.id,r=a.memberof,i=a.children,o=function(e,t){var n=e.selector,r=e.dataset,a=e.attr,i=e.style,o=e.html,s=n.match(/\.([^.#\s])+/g)||[],l=(n.match(/^[^.#\s]+/g)||[])[0]||"div",c=(n.match(/#[^.#\s]+/g)||[])[0]||"",u=document.createElement(l);if(c&&(u.id=c.replace(/^#/g,"")),u.className=s.map(function(e){return""+f+e.replace(/^\./g,"")}).join(" "),r)for(var d in r)u.setAttribute("data-"+d,r[d]);if(a)for(var d in a)u.setAttribute(d,a[d]);return i&&p(u,i),o&&(u.innerHTML=o),t&&t.appendChild(u),u}(a),s=t.structures,l=t.elements;return n&&[].concat(n).forEach(function(e){var t=-1<e.indexOf("[]"),n=t&&-1<e.indexOf("[][]");if(t){var r=e.replace(/\[\]/g,"");s[r]||(s[r]=[],l[r]=[]),n?(s[r].push([]),l[r].push([])):(s[r].push(a),l[r].push(o))}else s[e]=a,l[e]=o}),r&&(s[r]||(s[r]=[[]],l[r]=[[]]),s[r][s[r].length-1].push(a),l[r][l[r].length-1].push(o)),i&&[].concat(i).filter(function(e){return e}).forEach(function(e){y.isString(e)?x({selector:e},o,t):x(e,o,t)}),e&&e.appendChild(o),a.element=o,t.element=o,t}function k(t,n,e,r,a){var i=e.element,o=function(n,r,e,a){var t=n.map(e),i=r.map(e),o={},s={},l=[],c=[];return t.forEach(function(e,t){o[e]=t}),i.forEach(function(e,t){e in o?a(n[o[e]],r[t]):l.push(t),s[e]=t}),t.forEach(function(e,t){e in s||c.push(t)}),{added:l,removed:c}}(t,n,r,function(e,t){t.element=e.element,a&&a(e,t)}),s=o.added;o.removed.reverse().forEach(function(e){i.removeChild(t[e].element)}),s.forEach(function(e){var t=x(n[e]).element;i.insertBefore(t,n[e+1]&&n[e+1].element)}),e.children=n}function _(e,t){var n,r=t.split("///"),a=r.length,i=e;for(n=0;n<a&&"SceneItem"!==i.constructor.name;++n)i=e.getItem(r[n]);return{item:i,names:r.slice(0,n),properties:r.slice(n)}}function w(e,t){for(var n=e.length,r=0;r<n;++r){var a=e[r].getBoundingClientRect(),i=a.top,o=i+a.height;if(i<=t&&t<o)return r}return-1}function A(o,s){var l=[];return o.map(function(e,t){var n=e[0],r=c(e[1]);if(o[t+1]){var a=o[t+1],i=a[0];r===c(a[1])&&l.push({selector:".keyframe_line",dataset:{time:n+","+i,from:n,to:i},style:{left:n/s*100+"%",width:(i-n)/s*100+"%"}})}return{memberof:"keyframesInfoList",selector:".keyframe",dataset:{time:n,value:r},style:{left:n/s*100+"%"},html:n+" "+r}}).concat(l)}var E=0,z=-1,j=-1;function L(e){for(var t=[],n=0;n<=e;++n)t.push({dataset:{time:n},selector:".keytime",style:{width:100/e+"%"},children:[{selector:"span",html:""+n},{selector:".graduation.start"},{selector:".graduation.quarter"},{selector:".graduation.half"},{selector:".graduation.quarter3"}]});return t}function C(e){for(var t=[],n=0;n<=e;++n)t.push({selector:".division_line",style:{left:100/e*n+"%"}});return t}var T=!1;return function(){function e(e,t){this.propertiesNames=[],this.maxTime=0,this.selectedIndex=-1,e.finish(),this.scene=e,this.initElement(e,t),this.editor()}var t=e.prototype;return t.getElement=function(){return this.elements.timeline},t.initElement=function(e,t){var n,r=e.getDuration(),l=function(e){var l={};return e.forEach(function(t){var s=t.getDelay();t.times.forEach(function(o){var e=t.getFrame(o);!function t(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var r=e[e.length-1],a=e.slice(0,-1),i=a.join("///");i&&(l[i]||(l[i]=[]),l[i].push([s+o,r])),"object"==typeof r&&Object.keys(r).forEach(function(e){t.apply(void 0,a.concat([e,r[e]]))})}(t.getId(),e.get())})}),l}(e),a=Math.ceil(r),c=a+5,u=this.propertiesNames,d=[],f=[],p=[];this.maxTime=c,T||(n={selector:"style.style",html:v},T=!0);var i=function(e){var t=e.split("///"),n=t.length,r=l[e],a=t[n-1];u.push(e),d.push({id:"properties[]",selector:".property",dataset:{id:a,property:e,parent:t[n-2]||"",object:"0",item:t[0]},style:{paddingLeft:10+20*(n-1)+"px"},children:[{selector:".arrow"},{selector:"span",html:a}]});var i=r[0]&&y.isObject(r[0][1]);f.push({id:"values[]",selector:".value",dataset:{property:e,object:i?"1":"0"},children:{id:"inputs[]",selector:"input",attr:{value:r[0]?r[0][1]:""}}});var o=t.slice(0,-1).join("///");d.forEach(function(e){var t=e.dataset;t.property===o&&(t.object="1")});var s=A(r,c);p.push({id:["keyframesList[]","keyframesInfoList[][]"],selector:".keyframes",dataset:{property:e},children:{id:"keyframesContainers[]",selector:".keyframes_container",children:s}})};for(var o in l)i(o);var s=x({selector:".timeline",id:"timeline",children:[n,{selector:".header_area.control_area",children:[{selector:".properties_area",children:{selector:".property"}},{selector:".values_area",children:{selector:".value"}},{selector:".keyframes_area",children:{selector:".keyframes",children:[{selector:".time_area",id:"timeArea",html:"0"},{selector:".play_control_area",id:"playControlArea",children:[{selector:".control.prev",html:"prev"},{selector:".control.play",html:"play"},{selector:".control.next",html:"next"}]}]}}]},{selector:".header_area",children:[{id:["propertiesAreas[]"],selector:".properties_area",children:[{selector:".property",html:"Name"}]},{selector:".values_area",children:{selector:".value",html:"+"}},{id:"keyframesAreas[]",selector:".keyframes_area",children:{style:{minWidth:50*c+"px",width:100*(a?c/a:1)+"%"},id:"keyframesScrollAreas[]",selector:".keyframes_scroll_area",children:{selector:".keyframes",children:[{id:"keytimesContainer",selector:".keyframes_container",children:L(c)},{selector:".keyframe_cursor",id:"cursors[]"}]}}}]},{id:"scrollArea",selector:".scroll_area",children:[{id:"propertiesAreas[]",selector:".properties_area",children:[{selector:".properties_scroll_area",children:d}]},{id:"valuesArea",selector:".values_area",children:f},{id:"keyframesAreas[]",selector:".keyframes_area",children:{style:{minWidth:50*c+"px",width:100*(a?c/a:1)+"%"},id:"keyframesScrollAreas[]",selector:".keyframes_scroll_area",children:p.concat([{selector:".keyframe_cursor",id:"cursors[]"},{id:"lineArea",selector:".line_area",children:C(c)}])}}]}]},t),h=s.structures,m=s.elements;this.structures=h,this.elements=m,this.syncScroll(),this.wheelZoom(),this.dragKeyframes(),this.clickProperty()},t.syncScroll=function(){var e=this.elements.keyframesAreas,t=!1;e[0].addEventListener("scroll",function(){t?t=!1:(t=!0,e[1].scrollLeft=e[0].scrollLeft)}),e[1].addEventListener("scroll",function(){t?t=!1:(t=!0,e[0].scrollLeft=e[1].scrollLeft)})},t.wheelZoom=function(){var n=this.elements.keyframesScrollAreas,r=parseFloat(n[0].style.width),a=new i({zoom:{range:[100,1/0]}},{},{zoom:r});a.connect("zoom",new i.PinchInput(n[1],{scale:.7,hammerManagerOptions:{touchAction:"auto"}})),a.on("hold",function(e){console.log("hold"),e.inputEvent&&e.inputEvent.preventDefault()}),a.on("change",function(e){var t=e.pos.zoom;n.forEach(function(e){e.style.width=t+"%"}),e.inputEvent&&e.inputEvent.preventDefault()}),this.axes=a,n[0].addEventListener("wheel",function(e){var t=e.deltaY;a.setBy({zoom:t/r*5}),!e.deltaX&&e.preventDefault()})},t.select=function(e){var t=this.selectedIndex,n=this.structures.values,r=this.structures.properties,a=this.structures.keyframesList;this.selectedIndex=e,-1<t&&(b(r[t].element,"select"),b(n[t].element,"select"),b(a[t].element,"select")),-1<e&&(g(r[e].element,"select"),g(n[e].element,"select"),g(a[e].element,"select"))},t.clickProperty=function(){var n=this,e=this.elements,d=e.keyframesList,f=e.values;e.propertiesAreas[1].addEventListener("click",function(e){var o=n.elements.properties,s=o.length,t=h(e.target,function(e){return m(e,"arrow")}),l=h(e.target,function(e){return m(e,"property")});if(l){var c=o.indexOf(l);if(-1!==c)if(t){if("0"!==l.getAttribute("data-object")){var u="1"===l.getAttribute("data-fold");!function e(t){var n=o[c],r=n.getAttribute("data-property"),a="1"===n.getAttribute("data-fold"),i="1"===n.getAttribute("data-object");if(l!==n&&(u?t||(b(d[c],"fold"),b(f[c],"fold"),b(n,"fold")):(g(d[c],"fold"),g(f[c],"fold"),g(n,"fold"))),i)for(++c;c<s;++c){if(!(-1<o[c].getAttribute("data-property").indexOf(r))){--c;break}e(!t&&a)}}(u),l.setAttribute("data-fold",u?"0":"1")}}else n.select(c)}})},t.setInputs=function(e){var t=this.elements.valuesArea;for(var n in e)t.querySelector('[data-property="'+n+'"] input').value=e[n]},t.moveCursor=function(e){var t=this.elements.cursors,n=this.maxTime,r="calc("+100*e/n+"% + "+(15-30*e/n)+"px)";t.forEach(function(e){e.style.left=r})},t.dragKeyframes=function(){var c=this,i=this.structures,e=this.elements,a=e.scrollArea,n=e.timeArea,t=e.cursors,o=e.keyframesAreas,s=e.keyframesScrollAreas,u=this.scene;u.on("animate",function(e){var t=e.time;c.moveCursor(t),c.setInputs(function e(t,n){for(var r in void 0===n&&(n={}),t){var a=t[r];if(y.isObject(a)){var i=e("Frame"===a.constructor.name?a.get():a);for(var o in i)n[r+"///"+o]=i[o]}else n[r]=a}return n}(e.frames)),n.innerHTML=""+t});var d=function(e){var t=s[1].getBoundingClientRect(),n=t.width-30,r=t.left+15,a=Math.min(n,Math.max(e-r,0))/n,i=c.maxTime*a;return i=Math.round(20*i)/20},l=function(e){u.setTime(d(e))},f=function(e,t,n){var r=c.structures.keyframesList,a=w(r.map(function(e){return e.element}),n);if(-1!==a){var i=d(t),o=_(u,r[a].dataset.property),s=o.item,l=o.properties;c.editKeyframe(i,s.getNowValue(i,l),a,!0),c.updateKeytimes()}};r.drag(t[0],{dragstart:function(e){e.inputEvent.stopPropagation()},drag:function(e){var t=e.clientX;l(t)},container:window}),s.forEach(function(e){r.drag(e,{container:window,drag:function(e){var t=e.deltaX,n=e.deltaY,r=e.inputEvent;o[1].scrollLeft-=t,a.scrollTop-=n,r.preventDefault()},dragend:function(e){var t=e.isDrag,n=e.clientX,r=e.clientY,a=e.inputEvent;!t&&function(e,t,n){var r=h(e.target,function(e){return m(e,"keyframe")});r?u.setTime(r.getAttribute("data-time")):m(e.target,"keyframe_cursor")||l(t);var a=w(i.keyframesList.map(function(e){return e.element}),n);c.select(a),e.preventDefault()}(a,n,r),function(e,t,n,r,a){var i=y.now();e||(z===n&&j===r&&i-E<=500&&a(t,n,r),z=n,j=r,E=i)}(t,a,n,r,f)}})})},t.updateKeytimes=function(){var n=this.scene.getDuration()+5,e=this.maxTime;if(n!==e){this.maxTime=n;var t=this.structures.keytimesContainer,r=this.structures.lineArea,a=t.children,i=r.children,o=L(n),s=C(n);k(a,o,t,function(e){return e.dataset.time},function(e,t){p(t.element,t.style)}),k(i,s,r,function(e,t){return t},function(e,t){p(t.element,t.style)}),this.structures.keyframesContainers.forEach(function(e){var t=e.children;!function(e,a){e.forEach(function(e){var t=e.selector,n=e.dataset,r=e.style;".keyframe"===t?r.left=n.time/a*100+"%":(r.left=n.from/a*100+"%",r.width=(n.to-n.from)/a*100+"%")})}(t,n),t.forEach(function(e){p(e.element,e.style)})}),this.moveCursor(this.scene.getTime()),e&&e<n&&this.axes.setTo({zoom:this.axes.get(["zoom"]).zoom*n/e})}},t.updateKeyframes=function(e,n,t){var r=this.structures.keyframesContainers[t],a=r.children,i=n.length,o=this.scene,s=function(e,t){return t.reduce(function(e,t){return e.getItem(t)},e)}(o,e),l=s.times.filter(function(e){var t;return!i||(t=s.getFrame(e)).has.apply(t,n)}),c=s.getDelay();if(k(a,A(l.map(function(e){var t;return[c+e,(t=s.getFrame(e)).get.apply(t,n)]}),this.maxTime),r,function(e){return e.dataset.time}),i){var u=n.slice(0,-1),d=e.concat(u).join("///"),f=this.propertiesNames.indexOf(d);if(-1!==f)return void this.updateKeyframes(e,u,f)}o.setTime(o.getTime())},t.editKeyframe=function(e,t,n,r){var a=this.structures.values;if(!("1"===this.structures.properties[n].dataset.object)){var i=a[n].dataset.property,o=this.scene,s=_(o,i),l=s.names,c=s.properties,u=s.item;if(!r)if(""+u.getNowValue(e,c)===t)return;u.set.apply(u,[e].concat(c,[t])),o.setTime(e),this.updateKeyframes(l,c,n)}},t.edit=function(e,t,n){var r=h(e,function(e){return m(e,"value")});if(r){var a=this.elements.values.indexOf(r);-1!==a&&this.editKeyframe(this.scene.getTime(),t,a,n)}},t.editor=function(){var n=this,e=this.elements.valuesArea;e.addEventListener("keyup",function(e){if(13===e.keyCode){var t=e.target;n.edit(t,t.value,!0)}}),e.addEventListener("focusout",function(e){var t=e.target;n.edit(t,t.value)})},e}()});
//# sourceMappingURL=timeline.min.js.map
