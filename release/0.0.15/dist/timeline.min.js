/*
Copyright (c) 2019 Daybrush
name: @scenejs/timeline
license: MIT
author: Daybrush
repository: git+https://github.com/daybrush/scenejs-timeline.git
version: 0.0.15
*/
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("@daybrush/utils"),require("@daybrush/drag"),require("@egjs/axes"),require("keycon"),require("data-dom"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["@daybrush/utils","@daybrush/drag","@egjs/axes","keycon","data-dom","@egjs/component"],n):(e=e||self).Timeline=n(e.utils,e.utils,e.eg.Axes,e.KeyController,e.DataDOM,e.Component)}(this,function(b,r,o,s,c,e){"use strict";var a=function(e,n){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t])})(e,n)};var l=function(){return(l=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var i in n=arguments[t])Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);return e}).apply(this,arguments)},f="scenejs_editor_",d="PointerEvent"in window||"MSPointerEvent"in window,p="ontouchstart"in window,u=("\n.item_info {\n    position: fixed;\n    right: 0;\n    top: 0;\n    width: 200px;\n    background: #000;\n}\n.options_area {\n\n}\n.option_area {\n    position: relative;\n    border-bottom: 1px solid #777;\n    box-sizing: border-box;\n    white-space: nowrap;\n    background: rgba(90, 90, 90, 0.7);\n    font-size: 13px;\n    font-weight: bold;\n    color: #eee;\n    display: flex;\n}\n.option_name, .option_value {\n    width: 50%;\n    height: 30px;\n    line-height: 20px;\n    box-sizing: border-box;\n    padding: 5px;\n}\n.option_name {\n    border-right: 1px solid #999;\n}\n.option_value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n}\n".replace(/\.([^{,\s\d.]+)/g,"."+f+"$1"),'\n.timeline * {\n    box-sizing: border-box;\n}\n.timeline {\n  position: fixed;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  font-size: 0;\n  background: #000;\n  display: flex;\n  flex-direction: column;\n}\n.header_area, .scroll_area {\n   width: 100%;\n   position: relative;\n  display: flex;\n  -webkit-align-items: flex-start;\n  align-items: flex-start;\n}\n.header_area {\n  position: relative;\n  z-index: 10;\n  top: 0;\n  height: 30px;\n  min-height: 30px;\n}\n.header_area .keyframes {\n  padding: 0px;\n}\n.header_area .properties_area,\n.header_area .keyframes_area,\n.header_area .values_area,\n.header_area .keyframes_scroll_area {\n    height: 100%;\n}\n.header_area .property, .header_area .value, .header_area .keyframes {\n  height: 100%;\n}\n.header_area .property {\n    line-height: 30px;\n}\n.value .add {\n    text-align: center;\n    color: #fff;\n    line-height: 30px;\n    font-weight: bold;\n    font-size: 20px;\n    cursor: pointer;\n}\n.header_area .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.header_area .keyframe_cursor {\n    position: absolute;\n    border-top: 10px solid #4af;\n    border-left: 6px solid transparent;\n    border-right: 6px solid transparent;\n    width: 0;\n    height: 0;\n    bottom: 0;\n    top: auto;\n    background: none;\n    cursor: pointer;\n}\n.control_area .keyframes {\n    padding-left: 10px;\n}\n.play_control_area {\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n}\n.play_control_area .control {\n    position: relative;\n    display: inline-block;\n    vertical-align: middle;\n    color: white;\n    margin: 0px 15px;\n}\n.play {\n    border-left: 14px solid white;\n    border-top: 8px solid transparent;\n    border-bottom: 8px solid transparent;\n}\n.pause {\n    border-left: 4px solid #fff;\n    border-right: 4px solid #fff;\n    width: 14px;\n    height: 16px;\n}\n.prev {\n    border-right: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.prev:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    right: 100%;\n    transform: translate(0, -50%);\n    background: white;\n}\n.next {\n    border-left: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.next:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    transform: translate(0, -50%);\n    background: white;\n}\n.keytime {\n  position: relative;\n  display: inline-block;\n  height: 100%;\n  font-size: 13px;\n  font-weight: bold;\n  color: #777;\n}\n.keytime:last-child {\n  max-width: 0px;\n}\n.keytime span {\n  position: absolute;\n  line-height: 1;\n  bottom: 12px;\n  display: inline-block;\n  transform: translate(-50%);\n  color: #eee;\n}\n.keytime .graduation {\n  position: absolute;\n  bottom: 0;\n  width: 1px;\n  height: 10px;\n  background: #777;\n  transform: translate(-50%);\n}\n.keytime .graduation.half {\n  left: 50%;\n  height: 7px;\n}\n.keytime .graduation.quarter {\n  left: 25%;\n  height: 5px;\n}\n.keytime .graduation.quarter3 {\n  left: 75%;\n  height: 5px;\n}\n.scroll_area {\n  position: relative;\n  width: 100%;\n  height: calc(100% - 60px);\n  overflow: auto;\n}\n.properties_area, .keyframes_area, .values_area {\n  display: inline-block;\n  position: relative;\n  font-size: 16px;\n  overflow: auto;\n}\n\n.properties_area::-webkit-scrollbar, .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.properties_area {\n  width: 30%;\n  max-width: 200px;\n  box-sizing: border-box;\n}\n.values_area {\n    width: 50px;\n    min-width: 50px;\n    display: inline-block;\n    border-right: 1px solid #999;\n    box-sizing: border-box;\n}\n.value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n    text-align: center;\n}\n.value {\n\n}\n.alt .value input {\n    cursor: ew-resize;\n}\n.value[data-object="1"] input {\n    display: none;\n}\n.properties_scroll_area {\n  display: inline-block;\n  min-width: 100%;\n}\n.keyframes_area {\n  flex: 1;\n}\n.keyframes_scroll_area {\n  position: relative;\n  min-width: 300px;\n}\n.keyframes, .property, .value {\n  position: relative;\n  height: 30px;\n  line-height: 30px;\n  border-bottom: 1px solid #777;\n  box-sizing: border-box;\n  white-space: nowrap;\n  background: rgba(90, 90, 90, 0.7);\n  z-index: 1;\n}\n\n.property {\n  padding-left: 10px;\n  box-sizing: border-box;\n  font-size: 13px;\n  font-weight: bold;\n  color: #eee;\n}\n.property .remove {\n    position: absolute;\n    display: inline-block;\n    cursor: pointer;\n    width: 18px;\n    height: 18px;\n    top: 0;\n    bottom: 0;\n    right: 10px;\n    margin: auto;\n    border-radius: 50%;\n    border: 2px solid #fff;\n    vertical-align: middle;\n    display: none;\n    margin-left: 10px;\n    box-sizing: border-box;\n}\n.property .remove:before, .property .remove:after {\n    position: absolute;\n    content: "";\n    width: 8px;\n    height: 2px;\n    border-radius: 1px;\n    background: #fff;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    margin: auto;\n}\n.property .remove:before {\n    transform: rotate(45deg);\n}\n.property .remove:after {\n    transform: rotate(-45deg);\n}\n.property:hover .remove {\n    display: inline-block;\n}\n\n[data-item="1"], [data-item="1"] .add {\n    height: 30px;\n    line-height: 30px;\n}\n.time_area {\n    position: absolute;\n    top: 0;\n    left: 10px;\n    font-size: 13px;\n    color: #4af;\n    line-height: 30px;\n    font-weight: bold;\n    height: 100%;\n    line-height: 30px;\n    border: 0;\n    background: transparent;\n    outline: 0;\n}\n.time_area:after {\n    content: "s";\n}\n.property .arrow {\n    position: relative;\n    display: inline-block;\n    width: 20px;\n    height: 25px;\n    cursor: pointer;\n    vertical-align: middle;\n}\n.property .arrow:after {\n    content: "";\n    position: absolute;\n    top: 0;\n    right: 0;\n    left: 0;\n    bottom: 0;\n    margin: auto;\n    width: 0;\n    height: 0;\n    border-top: 6px solid #eee;\n    border-left: 4px solid transparent;\n    border-right: 4px solid transparent;\n}\n.property[data-fold="1"] .arrow:after {\n    border-top: 4px solid transparent;\n    border-bottom: 4px solid transparent;\n    border-right: 0;\n    border-left: 6px solid #eee;\n}\n.property[data-object="0"] .arrow {\n    display: none;\n}\n.property.fold, .keyframes.fold, .value.fold {\n    display: none;\n}\n.property.select, .value.select, .keyframes.select {\n    background: rgba(120, 120, 120, 0.7);\n}\n.keyframes {\n\n}\n.keyframe_delay {\n  position: absolute;\n  top: 3px;\n  bottom: 3px;\n  left: 0;\n  background: #4af;\n  opacity: 0.2;\n  z-index: 0;\n}\n.keyframe_group {\n    position: absolute;\n    top: 3px;\n    bottom: 3px;\n    left: 0;\n    background: #4af;\n    opacity: 0.6;\n    border: 1px solid rgba(0, 0, 0, 0.2);\n    border-left-color: rgba(255, 255, 255, 0.2);\n    border-top-color: rgba(255, 255, 255, 0.2);\n    z-index: 0;\n}\n.keyframe_line {\n  position: absolute;\n  height: 8px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  background: #666;\n  z-index: 0;\n}\n.keyframe {\n  position: absolute;\n  font-size: 0px;\n  width: 12px;\n  height: 12px;\n  top: 0px;\n  bottom: 0px;\n  margin: auto;\n  background: #fff;\n  border: 2px solid #383838;\n  border-radius: 2px;\n  box-sizing: border-box;\n  transform: translate(-50%) rotate(45deg);\n  z-index: 1;\n  cursor: pointer;\n}\n.keyframe[data-no="1"] {\n    opacity: 0.2;\n}\n.select .keyframe {\n    border-color: #555;\n}\n.keyframe.select {\n    background: #4af;\n}\n.keyframes_container, .line_area {\n  position: relative;\n  width: calc(100% - 30px);\n  left: 15px;\n  height: 100%;\n}\n.line_area {\n  position: absolute;\n  top: 0;\n  z-index: 0;\n}\n.keyframe_cursor {\n  position: absolute;\n  top: 0;\n  z-index: 1;\n  background: #4af;\n  width: 1px;\n  height: 100%;\n  left: 15px;\n  transform: translate(-50%);\n}\n.scroll_aare .keyframe_cursor {\n  pointer-events: none;\n}\n.division_line {\n  position: absolute;\n  background: #333;\n  width: 1px;\n  height: 100%;\n  transform: translate(-50%);\n}\n'.replace(/\.([^{,\s\d.]+)/g,"."+f+"$1")),w="direction",_="iterationCount",E="delay",A="playSpeed",T="alternate",z="reverse",P="alternate-reverse";function v(e,n,t){var r=(""+e).length,i=[];t&&i.push(e);for(var a=r;a<n;++a)i.push(0);return t||i.push(e),i.join("")}function m(e,n){for(var t in n)e.style[t]=n[t]}function h(n,e){return e.findIndex(function(e){return e.dataset.key===n})}function y(e){var n=e.selector,t=e.dataset,r=e.attr,i=e.style,a=e.html,o=n.match(/\.([^.#\s])+/g)||[],s=(n.match(/^[^.#\s]+/g)||[])[0]||"div",l=(n.match(/#[^.#\s]+/g)||[])[0]||"",c=document.createElement(s);if(l&&(c.id=l.replace(/^#/g,"")),c.className=o.map(function(e){return f+e.replace(/^\./g,"")}).join(" "),t)for(var d in t)c.setAttribute("data-"+d,t[d]);if(r)for(var d in r)c.setAttribute(d,r[d]);return i&&m(c,i),a&&(c.innerHTML=a),c}function g(e,n){var t=n.dataset,r=n.attr,i=n.style,a=n.html,o=n.element;if(t)for(var s in t)o.setAttribute("data-"+s,t[s]);if(r)for(var s in r)o.setAttribute(s,r[s]);i&&m(o,i),e.html!==n.html&&(o.innerHTML=a)}function k(n){return"object"==typeof n?Array.isArray(n)?"["+n.join(", ")+"]":"{"+function(e){var n=[];for(var t in e)n.push(t);return n}(n).map(function(e){return e+": "+k(n[e])}).join(", ")+"}":n}function x(e,n){for(var t=e;t&&t!==document.body;){if(n(t))return t;t=t.parentNode}return null}function I(e,n){return b.hasClass(e,f+n)}function L(e,n){return b.addClass(e,f+n)}function D(e,n){return b.removeClass(e,f+n)}function C(e){return!!e.constructor.prototype.getItem}function j(e,n){for(var t=e.length,r=0;r<t;++r){var i=e[r].getBoundingClientRect(),a=i.top,o=a+i.height;if(a<=n&&n<o)return r}return-1}var M=0,S=-1,K=-1;function O(n,e,t,r){return{ref:function(e){n.keyframesAreas[0]=e},selector:".keyframes_area",children:{style:{minWidth:50*r+"px",width:Math.min(t?r/t:1,2)*e*100+"%"},dataset:{width:Math.min(t?r/t:1,2)},ref:function(e){n.keyframesScrollAreas[0]=e},selector:".keyframes_scroll_area",children:{ref:function(e){n.cursors=[]},selector:".keyframes",children:[{ref:function(e){n.keytimesContainer=e},selector:".keyframes_container",children:function(e){for(var n=[],t=0;t<=e;++t)n.push({key:t,dataset:{time:t},selector:".keytime",style:{width:100/e+"%"},children:[{selector:"span",html:""+t},{selector:".graduation.start"},{selector:".graduation.quarter"},{selector:".graduation.half"},{selector:".graduation.quarter3"}]});return n}(r)},{selector:".keyframe_cursor",ref:function(e){n.cursors[0]=e}}]}}}}function q(n,e,t,r,i){var a=Math.min(r?i/r:1,2);return{ref:function(e){n.keyframesAreas[1]=e},selector:".keyframes_area",children:{style:{minWidth:50*i+"px",width:a*t*100+"%"},dataset:{width:a},ref:function(e){n.keyframesScrollAreas[1]=e},selector:".keyframes_scroll_area",children:function(n,e,t){return e.concat([{key:"cursor",selector:".keyframe_cursor",ref:function(e){n.cursors[1]=e}},{key:"lineArea",ref:function(e){n.lineArea=e},selector:".line_area",children:function(e){for(var n=[],t=0;t<=e;++t)n.push({key:t,selector:".division_line",style:{left:100/e*t+"%"}});return n}(t)}])}(n,e,i)}}}function B(e,f){var n=e.item,p=e.frames,u=e.properties,m=C(n),h=n.getDuration(),y=[],t=[],v=[],g=[],r=p.length;if(2<=r){var i=2!==r&&0===p[0][0]&&0===p[0][1]&&b.isUndefined(p[0][2])&&!u.length?p[1]:p[0],a=p[r-1],o=i[0],s=a[0];t.push({selector:".keyframe_group",key:"group",datas:{time:o+","+s,from:o,to:s},dataset:{time:o},style:{left:o/f*100+"%",width:(s-o)/f*100+"%"}})}return p.forEach(function(e,n){var t=e[0],r=e[1],i=e[2],a=k(i);if(0!==n||0!==t||0!==r||!b.isUndefined(i)||u.length){if(p[n+1]){var o=p[n+1],s=o[0],l=o[1],c=o[2],d=k(c);(0===r&&0===l||r===h&&l===h)&&v.push(function(e,n,t){return{selector:".keyframe_delay",key:"delay"+e+","+n,datas:{time:-1},style:{left:e/t*100+"%",width:(n-e)/t*100+"%"}}}(t,s,f)),m||b.isUndefined(i)||b.isUndefined(c)||a===d||g.push({selector:".keyframe_line",key:"line"+g.length,datas:{time:t+","+s,from:t,to:s},style:{left:t/f*100+"%",width:(s-t)/f*100+"%"}})}m||y.push({key:"keyframe"+y.length,selector:".keyframe",dataset:{time:t},datas:{time:t,iterationTime:r,value:a},style:{left:t/f*100+"%"},html:t+" "+a})}}),t.concat(y,v,g)}function F(n,e,t,r,i){var a=function(t,e,n){var r=[];for(var i in e){var a=e[i],o=B(a,n);r.push({ref:function(e,n){t.keyframesList[n]=e,t.keyframesContainers[n]=e.children},selector:".keyframes",key:i,dataset:{item:a.isItem?"1":"0",key:i},datas:a,children:{selector:".keyframes_container",children:o}})}return r}(n,e,i);return{ref:function(e){n.scrollArea=e,n.keyframesList=[],n.keyframesContainers=[]},selector:".scroll_area",children:[{ref:function(e){n.propertiesAreas[1]=e,n.properties=[]},selector:".properties_area",children:[{selector:".properties_scroll_area",children:function(t,e){var n=[];for(var r in e){var i=e[r],a=i.keys,o=a.length,s=a[o-1];n.push({ref:function(e,n){t.properties[n]=e},key:r,selector:".property",dataset:{key:r,object:i.isParent?"1":"0",item:i.isItem?"1":"0"},datas:i,style:{paddingLeft:10+20*(o-1)+"px"},children:[{selector:".arrow"},{selector:"span",html:s},{selector:".remove"}]})}return n}(n,e)}]},{ref:function(e){n.valuesArea=e,n.values=[]},selector:".values_area",children:function(t,e){var n=[];for(var r in e){var i=e[r],a=i.frames;n.push({ref:function(e,n){t.values[n]=e},key:r,selector:".value",dataset:{key:r,item:i.isItem?"1":"0",object:i.isParent?"1":"0"},datas:i,children:i.isParent?{key:"add",selector:".add",html:"+"}:{key:"input",selector:"input",attr:{value:a[0]?a[0][1]:""}}})}return n}(n,e)},q(n,a,t,r,i)]}}var n=1e6;function i(e){return Math.round(e*n)/n}function U(e,n,t){var r=e[e.length-1];(!r||r[0]!==n||r[1]!==t)&&e.push([i(n),i(t)])}function X(e,n){if(!e.length)return[];var k=e.map(function(e){return[e,e]}),x=[];return 0!==k[0][0]&&n[n.length-1][E]&&k.unshift([0,0]),n.forEach(function(e){for(var n,t,r=e[_],i=e[E],a=e[A],o=e[w],s=Math.ceil(r),l=k[k.length-1][0],c=k.length,d=l*r,f=0;f<s;++f)for(var p=o===z||o===T&&f%2||o===P&&!(f%2),u=0;u<c;++u){var m=k[p?c-u-1:u],h=m[1],y=l*f+(p?l-m[0]:m[0]),v=k[p?c-u:u-1];if(d<y){if(0!==u){var g=l*f+(p?l-v[0]:v[0]),b=(v[1]*(t=y-d)+h*(n=d-g))/(n+t);U(x,(i+l*r)/a,b)}break}if(y===d&&x.length&&x[x.length-1][0]===d+i)break;U(x,(i+y)/a,h)}i&&x.unshift([0,x[0][1]]),k=x,x=[]}),k}function N(e){var c={};return function n(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t.length,i=t[r-1],a=t.slice(1).map(function(e){return e.getId()});if(C(i)){if(a.length){var o=a.join("///"),s=X([0,i.getDuration()],t.slice(1).map(function(e){return e.state}).reverse()),l=[];s.forEach(function(e){var n=e[0],t=e[1];l.push([n,t,t])}),c[o]={key:o,keys:a,isItem:!0,isParent:!0,parentItem:t[r-2],item:i,names:[],properties:[],frames:l}}i.forEach(function(e){n.apply(void 0,t.concat([e]))})}else!function(d,e,f,p){p.update();var n=p.times.slice(),t=p.getDuration();!p.getFrame(0)&&n.unshift(0),!p.getFrame(t)&&n.push(t);var u=X(n,e.slice(1).map(function(e){return e.state}).reverse()),m=e[e.length-2];!function e(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];var a=[],r=b.isObject(n),o=0===i.length;u.forEach(function(e){var n=e[0],t=e[1],r=p.get.apply(p,[t].concat(i));b.isUndefined(r)&&i.length||a.push([n,t,r])});var s=f.concat(i),l=s.join("///");if(l&&(d[l]={key:l,keys:s,parentItem:m,isParent:r,isItem:o,item:p,names:f,properties:i,frames:a}),r)for(var c in n)e.apply(void 0,[n[c]].concat(i,[c]))}(p.names)}(c,t,a,i)}(e),c}var W=!1;return function(i){function e(e,n,t){void 0===t&&(t={});var r=i.call(this)||this;return r.maxTime=0,r.selectedProperty="",r.selectedTime=-1,r.ids={},r.options=l({keyboard:!0},t),e.finish(),r.scene=e,r.initStructure(e,n),r.initEditor(),r.initScroll(),r.initWheelZoom(),r.initDragKeyframes(),r.initClickProperty(),r.initController(),r.initDragValues(),r.initKeyController(),r.setTime(0),r}!function(e,n){function t(){this.constructor=e}a(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}(e,i);var n=e.prototype;return n.getElement=function(){return this.structure.element},n.prev=function(){this.setTime(this.scene.getTime()-.05)},n.next=function(){this.setTime(this.scene.getTime()+.05)},n.finish=function(){this.scene.finish()},n.togglePlay=function(){var e=this.scene;"running"===e.getPlayState()?e.pause():e.play()},n.setTime=function(e){var n=this.scene,t=n.getDirection();n.pause(),"normal"===t||"alternate"===t?n.setTime(e):n.setTime(n.getDuration()-e)},n.update=function(){var e=this.scene;this.timelineInfo=N(e);var n=Math.ceil(e.getDuration()),t=Math.max(this.maxTime,n),r=this.axes.get(["zoom"]).zoom,i=this.maxTime;this.maxTime=t;var a=this.ids,o=a.keyframesAreas[0],s=1<i?t/i:1;r=Math.max(1,r*s),this.axes.axm.set({zoom:r}),this.datadom.update(o,O(a,r,t,t));var l=F(a,this.timelineInfo,this.axes.get(["zoom"]).zoom,t,t);this.datadom.update(a.scrollArea,l),this.setTime(e.getTime())},n.newItem=function(e){var n=prompt("Add Item");n&&(this.scene.newItem(n),this.update())},n.newProperty=function(e,n){var t=prompt("new property");t&&(e.set.apply(e,[e.getIterationTime()].concat(n,[t,0])),this.update())},n.initController=function(){var i=this,a=this.ids,e=this.ids.playBtn.element,n=this.scene;this.ids.addItem.element.addEventListener("click",function(e){C(i.scene)?i.newItem(i.scene):i.newProperty(i.scene,[])}),e.addEventListener("click",function(e){i.togglePlay(),e.preventDefault()}),a.unselectedArea.element.addEventListener("click",function(e){i.select("",-1)}),a.prevBtn.element.addEventListener("click",function(e){i.prev(),e.preventDefault()}),a.nextBtn.element.addEventListener("click",function(e){i.next(),e.preventDefault()}),n.on("play",function(){L(e,"pause"),D(e,"play")}),n.on("paused",function(){L(e,"play"),D(e,"pause")}),this.options.keyboard&&new s(a.timeArea.element).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=a.timeArea.element.value,t=/(\d+):(\d+):(\d+)/g.exec(n);if(t){var r=60*parseFloat(t[1])+parseFloat(t[2])+parseFloat("0."+t[3]);i.setTime(r)}})},n.initKeyController=function(){var n=this,e=this.ids;window.addEventListener("blur",function(){D(e.timeline.element,"alt")}),this.keycon=(new s).keydown("alt",function(){L(e.timeline.element,"alt")}).keyup("alt",function(){D(e.timeline.element,"alt")}),this.options.keyboard&&this.keycon.keydown("space",function(e){e.inputEvent.preventDefault()}).keydown("left",function(e){n.prev()}).keydown("right",function(e){n.next()}).keyup("backspace",function(){n.removeKeyframe(n.selectedProperty)}).keyup("esc",function(){n.finish()}).keyup("space",function(){n.togglePlay()})},n.initStructure=function(e,n){var a=this;this.timelineInfo=N(e);var t,r=Math.ceil(e.getDuration()),i=Math.ceil(r),o=i,s=this.ids;this.maxTime=o,W||(t={selector:"style.style",html:u},W=!0);var l={selector:".timeline",ref:function(e){s.timeline=e},children:[t,function(n){return{selector:".header_area.control_area",children:[{selector:".properties_area",ref:function(e){n.unselectedArea=e},children:{selector:".property"}},{selector:".values_area",children:{selector:".value"}},{selector:".keyframes_area",children:{selector:".keyframes",children:[{selector:"input.time_area",ref:function(e){n.timeArea=e},html:"???"},{selector:".play_control_area",children:[{ref:function(e){n.prevBtn=e},selector:".control.prev"},{ref:function(e){n.playBtn=e},selector:".control.play"},{ref:function(e){n.nextBtn=e},selector:".control.next"}]}]}}]}}(s),function(n,e,t,r){return{selector:".header_area",ref:function(e){n.keyframesScrollAreas=[],n.keyframesAreas=[],n.propertiesAreas=[]},children:[{ref:function(e){n.propertiesAreas[0]=e},selector:".properties_area",children:[{selector:".property",html:"Name"}]},{selector:".values_area",children:{selector:".value",children:{key:"add",selector:".add",html:"+",ref:function(e){n.addItem=e}}}},O(n,e,t,r)]}}(s,1,i,o),F(s,this.timelineInfo,1,i,o)]};this.datadom=new c(y,g),this.structure=this.datadom.render(l,n),this.ids.properties.forEach(function(e,n){var t=e.datas,r=t.keys,i=t.isParent;1===r.length&&i&&a.fold(n)})},n.initScroll=function(){var e=this.ids.keyframesAreas,n=!1,t=e[0].element,r=e[1].element;t.addEventListener("scroll",function(){n?n=!1:(n=!0,r.scrollLeft=t.scrollLeft)}),r.addEventListener("scroll",function(){n?n=!1:(n=!0,t.scrollLeft=r.scrollLeft)})},n.initWheelZoom=function(){var t=this,r=this.ids,e=r.keyframesScrollAreas,n=e[0].element,i=e[1].element,a=new o({zoom:{range:[1,1/0]}},{},{zoom:1});(p||d)&&a.connect("zoom",new o.PinchInput(i,{scale:.1,hammerManagerOptions:{touchAction:"auto"}})),a.on("hold",function(e){e.inputEvent&&e.inputEvent.preventDefault()}),a.on("change",function(e){var n=r.keyframesScrollAreas[0].dataset.width,t=e.pos.zoom*n*100;r.keyframesScrollAreas.forEach(function(e){e.element.style.width=t+"%"}),e.inputEvent&&e.inputEvent.preventDefault()}),this.axes=a,n.addEventListener("wheel",function(e){var n=e.deltaY;a.setBy({zoom:n/5e3}),!e.deltaX&&e.preventDefault()}),b.addEvent(i,"wheel",function(e){if(t.keycon.altKey){e.preventDefault();var n=e.deltaY;a.setBy({zoom:n/5e3})}})},n.select=function(e,n){var t=this.selectedProperty,r=this.selectedTime,i=this.ids,a=i.values,o=i.properties,s=i.keyframesList;if(this.selectedProperty=e,this.scene.pause(),t){var l=h(t,o);if(D(o[l].element,"select"),D(a[l].element,"select"),D(s[l].element,"select"),0<=r)i.keyframesContainers[l].children.forEach(function(e){e.datas.time===r&&D(e.element,"select")}),this.selectedTime=-1}var c=this.scene;if(e){document.activeElement&&document.activeElement.blur();var d=h(e,o);if(L(o[d].element,"select"),L(a[d].element,"select"),L(s[d].element,"select"),c=i.keyframesList[d].datas.item,0<=n)i.keyframesContainers[d].children.forEach(function(e){e.datas.time===n&&L(e.element,"select")}),this.selectedTime=n}this.trigger("select",{selectedItem:c,selectedProperty:this.selectedProperty,selectedTime:this.selectedTime,prevSelectedProperty:t,prevSelectedTime:r})},n.initClickProperty=function(){var s=this,l=this.ids;l.propertiesAreas[1].element.addEventListener("click",function(e){var n=l.properties.map(function(e){return e.element}),t=(n.length,x(e.target,function(e){return I(e,"arrow")})),r=x(e.target,function(e){return I(e,"remove")}),i=x(e.target,function(e){return I(e,"property")});if(i){var a=n.indexOf(i);if(-1!==a){var o=l.properties[a];r?s.remove(o.datas):(s.select(o.dataset.key),t&&s.fold(a))}}})},n.setInputs=function(e){var n=this.ids.valuesArea.element;for(var t in e)n.querySelector('[data-key="'+t+'"] input').value=e[t]},n.moveCursor=function(e){var n=this.ids.cursors,t=this.maxTime,r="calc("+100*e/t+"% + "+(15-30*e/t)+"px)";n.forEach(function(e){e.element.style.left=r})},n.initDragKeyframes=function(){var s=this,l=this.ids,a=l.scrollArea,o=l.timeArea,e=l.cursors,c=l.keyframesAreas,d=l.keyframesScrollAreas;this.scene.on("animate",function(e){var n=e.time;s.moveCursor(n),s.setInputs(function e(n,t){for(var r in void 0===t&&(t={}),n){var i=n[r];if(b.isObject(i)){var a=e(i.constructor.prototype.toCSS?i.get():i);for(var o in a)t[r+"///"+o]=a[o]}else t[r]=i}return t}(e.frames||e.frame.get()));var t=v(Math.floor(n/60),2),r=v(Math.floor(n%60),2),i=v(Math.floor(n%1*100),3,!0);o.element.value=t+":"+r+":"+i});var f=function(e,n){void 0===n&&(n=d[1].element.getBoundingClientRect());var t=n.width-30,r=Math.min(t,e)/t,i=s.maxTime*r;return Math.round(20*i)/20},p=function(e){var n=d[1].element.getBoundingClientRect(),t=n.left+15,r=Math.max(e-t,0);return f(r,n)},u=function(e,n,t){var r=j(l.keyframesList.map(function(e){return e.element}),t);-1!==r&&s.addKeyframe(r,p(n))};r.drag(e[0].element,{dragstart:function(e){e.inputEvent.stopPropagation()},drag:function(e){!function(e){s.setTime(p(e))}(e.clientX)},container:window});var m=null,h=0,y=null;d.forEach(function(e){var n=e.element;r.drag(n,{container:window,dragstart:function(e){var n=e.inputEvent;if(y=x(n.target,function(e){return I(e,"keyframe_group")})){var t=s.ids.properties,r=function(n,e){return e.find(function(e){return e.dataset.key===n})}(x(y,function(e){return I(e,"keyframes")}).getAttribute("data-key"),t).datas;m=r.item,h=m.getDelay()}},drag:function(e){var n=e.distX,t=e.deltaX,r=e.deltaY,i=e.inputEvent;y?(m.setDelay(Math.max(h+f(n),0)),s.update()):(c[1].element.scrollLeft-=t,a.element.scrollTop-=r,i.preventDefault())},dragend:function(e){var n=e.isDrag,t=e.clientX,r=e.clientY,i=e.inputEvent;h=m=y=null,!n&&function(e,n,t){var r=x(e.target,function(e){return I(e,"keyframe")}),i=r?parseFloat(r.getAttribute("data-time")):p(n);s.setTime(i);var a=l.keyframesList,o=j(a.map(function(e){return e.element}),t);-1<o&&s.select(a[o].dataset.key,i),e.preventDefault()}(i,t,r),function(e,n,t,r,i){var a=b.now();e||(S===t&&K===r&&a-M<=500&&i(n,t,r),S=t,K=r,M=a)}(n,i,t,r,u)}})})},n.initDragValues=function(){var t,o=this,s=this.ids,e=s.valuesArea.element,l=null;b.addEvent(e,"click",function(e){var n=x(l,function(e){return I(e,"add")});if(n){var t=h(n.parentElement.getAttribute("data-key"),s.values);if(!(t<0)){var r=s.properties[t].datas,i=r.properties.slice(),a=r.item;C(a)?o.newItem(a):o.newProperty(a,i)}}}),r.drag(e,{container:window,dragstart:function(e){if(l=e.inputEvent.target,t=l.value,!o.keycon.altKey||!x(l,function(e){return"INPUT"===e.nodeName}))return!1},drag:function(n){var e=t.replace(/-?\d+/g,function(e){return""+(parseFloat(e)+Math.round(n.distX/2))});l.value=e},dragend:function(e){o.edit(l,l.value)}})},n.addKeyframe=function(e,n){var t=this.ids.keyframesList,r=t[e].dataset.key,i=t[e].datas;i.item,i.properties;this.select(r,n);var a=this.ids.values[e].children.element.value;this.editKeyframe(e,a)},n.fold=function(r,e){var n,i=this,t=this.ids,a=t.properties,o=t.values,s=t.keyframesList,l=a[r],c=a.length;for(n=r+1;n<c&&0===a[n].datas.key.indexOf(l.datas.key+"///");++n);var d=a.slice(r+1,n),f=o.slice(r+1,n),p=s.slice(r+1,n),u=l.element,m=b.isUndefined(e)?"1"===u.getAttribute("data-fold"):e;u.setAttribute("data-fold",m?"0":"1");var h=m?D:L,y=l.datas.keys.length;d.forEach(function(e,n){var t=e.datas;y+1<t.keys.length||(h(e.element,"fold"),h(f[n].element,"fold"),h(p[n].element,"fold"),t.isParent?m?e.element.setAttribute("data-fold","1"):i.fold(r+1+n,!1):e.element.setAttribute("data-fold",m?"0":"1"))})},n.remove=function(e){var n=e.key,t=e.isItem,r=e.parentItem,i=e.item,a=e.properties;if(t){var o=null;r.forEach(function(e,n){e!==i||(o=n)}),null!=o&&r.removeItem(o)}else{i.times.forEach(function(e){var n;(n=i).remove.apply(n,[e].concat(a))})}this.selectedProperty===n&&(this.selectedProperty="",this.selectedTime=-1),this.update()},n.removeKeyframe=function(e){var n=this.timelineInfo[e];if(e&&n&&!C(n.item)){var t=n.properties,r=n.item;r.remove.apply(r,[r.getIterationTime()].concat(t)),this.update()}},n.editKeyframe=function(e,n){var t=this.ids;if(!("1"===t.properties[e].dataset.object)){var r=t.keyframesList[e].datas,i=r.item,a=r.properties;i.set.apply(i,[i.getIterationTime()].concat(a,[n])),this.update()}},n.restoreKeyframes=function(){this.setTime(this.scene.getTime())},n.edit=function(e,n){var t=x(e,function(e){return I(e,"value")});if(t){var r=this.ids.values.map(function(e){return e.element}).indexOf(t);-1!==r&&this.editKeyframe(r,n)}},n.initEditor=function(){var t=this,e=this.ids.valuesArea.element;new s(e).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=e.inputEvent.target;t.edit(n,n.value)}).keyup("esc",function(e){e.inputEvent.target.blur()}),e.addEventListener("focusout",function(e){t.restoreKeyframes()})},e}(e)});
//# sourceMappingURL=timeline.min.js.map
