/*
Copyright (c) 2019 Daybrush
name: @scenejs/timeline
license: MIT
author: Daybrush
repository: git+https://github.com/daybrush/scenejs-timeline.git
version: 0.0.6
*/
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("@daybrush/utils"),require("@daybrush/drag"),require("@egjs/axes"),require("keycon"),require("data-dom"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["@daybrush/utils","@daybrush/drag","@egjs/axes","keycon","data-dom","@egjs/component"],n):(e=e||self).Timeline=n(e.utils,e.utils,e.eg.Axes,e.KeyController,e.DataDOM,e.Component)}(this,function(y,p,o,s,l,e){"use strict";var i=function(e,n){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t])})(e,n)};var d="scenejs_editor_",r="\n.item_info {\n    position: fixed;\n    right: 0;\n    top: 0;\n    width: 200px;\n    background: #000;\n}\n.options_area {\n\n}\n.option_area {\n    position: relative;\n    border-bottom: 1px solid #777;\n    box-sizing: border-box;\n    white-space: nowrap;\n    background: rgba(90, 90, 90, 0.7);\n    font-size: 13px;\n    font-weight: bold;\n    color: #eee;\n    display: flex;\n}\n.option_name, .option_value {\n    width: 50%;\n    height: 30px;\n    line-height: 20px;\n    box-sizing: border-box;\n    padding: 5px;\n}\n.option_name {\n    border-right: 1px solid #999;\n}\n.option_value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n}\n".replace(/\.([^{,\s\d.]+)/g,"."+d+"$1"),c='\n.timeline {\n  position: fixed;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  font-size: 0;\n  background: #000;\n  display: flex;\n  flex-direction: column;\n}\n.header_area, .scroll_area {\n   width: 100%;\n   position: relative;\n  display: flex;\n  -webkit-align-items: flex-start;\n  align-items: flex-start;\n}\n.header_area {\n  position: relative;\n  z-index: 10;\n  top: 0;\n  height: 30px;\n  min-height: 30px;\n}\n.header_area .keyframes {\n  padding: 0px;\n}\n.header_area .properties_area,\n.header_area .keyframes_area,\n.header_area .values_area,\n.header_area .keyframes_scroll_area {\n    height: 100%;\n}\n.header_area .property, .header_area .value, .header_area .keyframes {\n  height: 100%;\n}\n.header_area .property {\n    line-height: 30px;\n}\n.header_area .value {\n    text-align: center;\n    color: #fff;\n    line-height: 30px;\n    font-weight: bold;\n    font-size: 20px;\n}\n.header_area .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.header_area .keyframe_cursor {\n    position: absolute;\n    border-top: 10px solid #4af;\n    border-left: 6px solid transparent;\n    border-right: 6px solid transparent;\n    width: 0;\n    height: 0;\n    bottom: 0;\n    top: auto;\n    background: none;\n    cursor: pointer;\n}\n.control_area .keyframes {\n    padding-left: 10px;\n}\n.play_control_area {\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n}\n.play_control_area .control {\n    position: relative;\n    display: inline-block;\n    vertical-align: middle;\n    color: white;\n    margin: 0px 15px;\n}\n.play {\n    border-left: 14px solid white;\n    border-top: 8px solid transparent;\n    border-bottom: 8px solid transparent;\n}\n.pause {\n    border-left: 4px solid #fff;\n    border-right: 4px solid #fff;\n    width: 6px;\n    height: 16px;\n}\n.prev {\n    border-right: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.prev:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    right: 100%;\n    transform: translate(0, -50%);\n    background: white;\n}\n.next {\n    border-left: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.next:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    transform: translate(0, -50%);\n    background: white;\n}\n.keytime {\n  position: relative;\n  display: inline-block;\n  height: 100%;\n  font-size: 13px;\n  font-weight: bold;\n  color: #777;\n}\n.keytime:last-child {\n  max-width: 0px;\n}\n.keytime span {\n  position: absolute;\n  top: 2px;\n  left: 0;\n  display: inline-block;\n  transform: translate(-50%);\n  color: #eee;\n}\n.keytime .graduation {\n  position: absolute;\n  bottom: 0;\n  width: 1px;\n  height: 10px;\n  background: #777;\n  transform: translate(-50%);\n}\n.keytime .graduation.half {\n  left: 50%;\n  height: 7px;\n}\n.keytime .graduation.quarter {\n  left: 25%;\n  height: 5px;\n}\n.keytime .graduation.quarter3 {\n  left: 75%;\n  height: 5px;\n}\n.scroll_area {\n  position: relative;\n  width: 100%;\n  height: calc(100% - 60px);\n  overflow: auto;\n}\n.properties_area, .keyframes_area, .values_area {\n  display: inline-block;\n  position: relative;\n  font-size: 16px;\n  overflow: auto;\n}\n\n.properties_area::-webkit-scrollbar, .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.properties_area {\n  width: 30%;\n  max-width: 200px;\n  box-sizing: border-box;\n}\n.values_area {\n    width: 50px;\n    min-width: 50px;\n    display: inline-block;\n    border-right: 1px solid #999;\n    box-sizing: border-box;\n}\n.value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n    text-align: center;\n}\n.alt .value input {\n    cursor: ew-resize;\n}\n.value[data-object="1"] input {\n    display: none;\n}\n.properties_scroll_area {\n  display: inline-block;\n  min-width: 100%;\n}\n.keyframes_area {\n  flex: 1;\n}\n.keyframes_scroll_area {\n  position: relative;\n  min-width: 300px;\n}\n.keyframes, .property, .value {\n  position: relative;\n  height: 25px;\n  border-bottom: 1px solid #777;\n  box-sizing: border-box;\n  white-space: nowrap;\n  background: rgba(90, 90, 90, 0.7);\n  z-index: 1;\n}\n\n.property {\n  line-height: 25px;\n  padding-left: 10px;\n  box-sizing: border-box;\n  font-size: 13px;\n  font-weight: bold;\n  color: #eee;\n}\n.time_area {\n    font-size: 13px;\n    color: #4af;\n    line-height: 30px;\n    font-weight: bold;\n    height: 100%;\n    line-height: 30px;\n    border: 0;\n    background: transparent;\n    outline: 0;\n}\n.time_area:after {\n    content: "s";\n}\n.property .arrow {\n    position: relative;\n    display: inline-block;\n    margin-right: 5px;\n    width: 0;\n    vertical-align: middle;\n    cursor: pointer;\n    border-top: 6px solid #eee;\n    border-left: 4px solid transparent;\n    border-right: 4px solid transparent;\n}\n.property[data-fold="1"] .arrow {\n    border-top: 4px solid transparent;\n    border-bottom: 4px solid transparent;\n    border-right: 0;\n    border-left: 6px solid #eee;\n    margin-left: 2px;\n}\n.property[data-object="0"] .arrow {\n    display: none;\n}\n.property.fold, .keyframes.fold, .value.fold {\n    display: none;\n}\n.property.select, .value.select, .keyframes.select {\n    background: rgba(120, 120, 120, 0.7);\n}\n.keyframes {\n\n}\n.keyframe_delay {\n  position: absolute;\n  height: 100%;\n  top: 0;\n  left: 0;\n  background: #4af;\n  opacity: 0.2;\n  z-index: 0;\n}\n.keyframe_line {\n  position: absolute;\n  height: 8px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  background: #666;\n  z-index: 0;\n}\n.keyframe {\n  position: absolute;\n  font-size: 0px;\n  width: 12px;\n  height: 12px;\n  top: 0px;\n  bottom: 0px;\n  margin: auto;\n  background: #fff;\n  border: 2px solid #383838;\n  border-radius: 2px;\n  box-sizing: border-box;\n  transform: translate(-50%) rotate(45deg);\n  z-index: 1;\n  cursor: pointer;\n}\n.keyframe[data-no="1"] {\n    opacity: 0.2;\n}\n.select .keyframe {\n    border-color: #555;\n}\n.keyframe.select {\n    background: #4af;\n}\n.keyframes_container, .line_area {\n  position: relative;\n  width: calc(100% - 30px);\n  left: 15px;\n  height: 100%;\n}\n.line_area {\n  position: absolute;\n  top: 0;\n  z-index: 0;\n}\n.keyframe_cursor {\n  position: absolute;\n  top: 0;\n  z-index: 1;\n  background: #4af;\n  width: 1px;\n  height: 100%;\n  left: 15px;\n  transform: translate(-50%);\n}\n.division_line {\n  position: absolute;\n  background: #333;\n  width: 1px;\n  height: 100%;\n  transform: translate(-50%);\n}\n'.replace(/\.([^{,\s\d.]+)/g,"."+d+"$1"),_="direction",w="iterationCount",A="delay",E="playSpeed",T="alternate",z="reverse",P="alternate-reverse";function h(e,n,t){var r=(""+e).length,i=[];t&&i.push(e);for(var a=r;a<n;++a)i.push(0);return t||i.push(e),i.join("")}function f(e,n){for(var t in n)e.style[t]=n[t]}function m(n,e){return e.findIndex(function(e){return e.dataset.key===n})}function u(e){var n=e.selector,t=e.dataset,r=e.attr,i=e.style,a=e.html,o=n.match(/\.([^.#\s])+/g)||[],s=(n.match(/^[^.#\s]+/g)||[])[0]||"div",l=(n.match(/#[^.#\s]+/g)||[])[0]||"",c=document.createElement(s);if(l&&(c.id=l.replace(/^#/g,"")),c.className=o.map(function(e){return""+d+e.replace(/^\./g,"")}).join(" "),t)for(var u in t)c.setAttribute("data-"+u,t[u]);if(r)for(var u in r)c.setAttribute(u,r[u]);return i&&f(c,i),a&&(c.innerHTML=a),c}function v(e,n){var t=n.dataset,r=n.attr,i=n.style,a=n.html,o=n.element;if(t)for(var s in t)o.setAttribute("data-"+s,t[s]);if(r)for(var s in r)o.setAttribute(s,r[s]);i&&f(o,i),e.html!==n.html&&(o.innerHTML=a)}function g(n){return"object"==typeof n?Array.isArray(n)?"["+n.join(", ")+"]":"{"+function(e){var n=[];for(var t in e)n.push(t);return n}(n).map(function(e){return e+": "+g(n[e])}).join(", ")+"}":n}function k(e,n){for(var t=e;t&&t!==document.body;){if(n(t))return t;t=t.parentNode}return null}function b(e,n){return y.hasClass(e,""+d+n)}function x(e,n){return y.addClass(e,""+d+n)}function C(e,n){return y.removeClass(e,""+d+n)}function D(e){return!!e.constructor.prototype.getItem}function L(e,n){for(var t=e.length,r=0;r<t;++r){var i=e[r].getBoundingClientRect(),a=i.top,o=a+i.height;if(a<=n&&n<o)return r}return-1}var I=0,S=-1,j=-1;function M(n,e,t,r){return{ref:function(e){n.keyframesAreas[0]=e},selector:".keyframes_area",children:{style:{minWidth:50*r+"px",width:Math.min(t?r/t:1,2)*e*100+"%"},dataset:{width:Math.min(t?r/t:1,2)},ref:function(e){n.keyframesScrollAreas[0]=e},selector:".keyframes_scroll_area",children:{ref:function(e){n.cursors=[]},selector:".keyframes",children:[{ref:function(e){n.keytimesContainer=e},selector:".keyframes_container",children:function(e){for(var n=[],t=0;t<=e;++t)n.push({key:t,dataset:{time:t},selector:".keytime",style:{width:100/e+"%"},children:[{selector:"span",html:""+t},{selector:".graduation.start"},{selector:".graduation.quarter"},{selector:".graduation.half"},{selector:".graduation.quarter3"}]});return n}(r)},{selector:".keyframe_cursor",ref:function(e){n.cursors[0]=e}}]}}}}function K(n,e,t,r,i){var a=Math.min(r?i/r:1,2);return{ref:function(e){n.keyframesAreas[1]=e},selector:".keyframes_area",children:{style:{minWidth:50*i+"px",width:a*t*100+"%"},dataset:{width:a},ref:function(e){n.keyframesScrollAreas[1]=e},selector:".keyframes_scroll_area",children:function(n,e,t){return e.concat([{key:"cursor",selector:".keyframe_cursor",ref:function(e){n.cursors[1]=e}},{key:"lineArea",ref:function(e){n.lineArea=e},selector:".line_area",children:function(e){for(var n=[],t=0;t<=e;++t)n.push({key:t,selector:".division_line",style:{left:100/e*t+"%"}});return n}(t)}])}(n,e,i)}}}function F(e,d){var f=[],p=e.item.getDuration(),h=e.frames,m=[];return h.map(function(e,n){var t=e[0],r=e[1],i=e[2],a=g(i);if(h[n+1]){var o=h[n+1],s=o[0],l=o[1],c=o[2],u=g(c);(0===r&&0===l||r===p&&l===p)&&m.push(function(e,n,t){return{selector:".keyframe_delay",key:"delay"+e+","+n,datas:{time:-1},style:{left:e/t*100+"%",width:(n-e)/t*100+"%"}}}(t,s,d)),y.isUndefined(i)||y.isUndefined(c)||a===u||f.push({selector:".keyframe_line",key:t+","+s,datas:{time:t+","+s,from:t,to:s},style:{left:t/d*100+"%",width:(s-t)/d*100+"%"}})}return{key:t,selector:".keyframe",dataset:{time:t},datas:{time:t,iterationTime:r,value:a},style:{left:t/d*100+"%"},html:t+" "+a}}).concat(m,f)}function q(n,e,t,r,i){var a=function(t,e,n){var r=[];for(var i in e){var a=e[i],o=F(a,n);r.push({ref:function(e,n){t.keyframesList[n]=e,t.keyframesContainers[n]=e.children},selector:".keyframes",key:i,dataset:{key:i},datas:a,children:{selector:".keyframes_container",children:o}})}return r}(n,e,i);return{ref:function(e){n.scrollArea=e,n.keyframesList=[],n.keyframesContainers=[]},selector:".scroll_area",children:[{ref:function(e){n.propertiesAreas[1]=e,n.properties=[]},selector:".properties_area",children:[{selector:".properties_scroll_area",children:function(t,e){var n=[];for(var r in e){var i=e[r],a=r.split("///"),o=a.length,s=a[o-1];n.push({ref:function(e,n){t.properties[n]=e},key:r,selector:".property",dataset:{key:r,object:i.isParent?"1":"0"},datas:i,style:{paddingLeft:10+20*(o-1)+"px"},children:[{selector:".arrow"},{selector:"span",html:s}]})}return n}(n,e)}]},{ref:function(e){n.valuesArea=e,n.values=[]},selector:".values_area",children:function(t,e){var n=[];for(var r in e){var i=e[r],a=i.frames;n.push({ref:function(e,n){t.values[n]=e},key:r,selector:".value",dataset:{key:r,object:i.isParent?"1":"0"},datas:i,children:{selector:"input",attr:{value:a[0]?a[0][1]:""}}})}return n}(n,e)},K(n,a,t,r,i)]}}function n(e,n){return{selector:".option_area",children:[{selector:".option_name",html:e},{selector:".option_value",dataset:{option:e},children:{selector:"input",dataset:{option:e},ref:function(e){e.element.value=y.isUndefined(n)?"":n}}}]}}function a(e){return[n("delay",e&&e.getDelay()),n("easing",e&&e.getEasingName()),n("iterationCount",e&&e.getIterationCount()),n("playSpeed",e&&e.getPlaySpeed()),n("fillMode",e&&e.getFillMode()),n("direction",e&&e.getDirection()),n("duration",e&&e.getDuration()),n("lastFrame",e&&e.getDuration())]}var B=function(){function e(e,n){var t=this;this.timeline=e,this.select=function(e){t.selectedItem=e.selectedItem,t.update()},e.on("select",this.select),this.datadom=new l(u,v),this.selectedItem=e.scene,this.infoArea=this.datadom.render({selector:".item_info",children:[{selector:"style",html:r},{ref:function(e){t.optionArea=e},selector:".options_area",children:a(e.scene)}]},n),this.init()}var n=e.prototype;return n.update=function(){this.datadom.update(this.optionArea.children,a(this.selectedItem),this.optionArea)},n.init=function(){var o=this;new s(this.infoArea.element).keydown(function(e){e.inputEvent.stopPropagation()}).keyup(function(e){e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=o.selectedItem;if(o.selectedItem){var t=k(e.inputEvent.target,function(e){return"INPUT"===e.nodeName});if(t){var r=t.getAttribute("data-option"),i=t.value;if("delay"===r)n.setDelay(parseFloat(i));else if("lastFrame"===r){var a=parseFloat(i);(function(e){return!!e.constructor.prototype.getFrame})(n)&&n.getDuration()<a&&n.newFrame(a)}else"playSpeed"===r?n.setPlaySpeed(parseFloat(i)):"direction"===r?n.setDirection(i):"iterationCount"===r?n.setIterationCount("infinite"===i?i:parseFloat(i)):"easing"===r&&n.setEasing(i);o.timeline.update(),o.update()}}})},e}(),t=1e6;function N(e){return Math.round(e*t)/t}function O(e,n,t){var r=e[e.length-1];(!r||r[0]!==n||r[1]!==t)&&e.push([N(n),N(t)])}function U(s,e,l,c){c.update();var u=function(e,n){var b=e.map(function(e){return[e,e]}),x=[];return n.forEach(function(e){for(var n,t,r=e[w],i=e[A],a=e[E],o=e[_],s=Math.ceil(r),l=b[b.length-1][0],c=b.length,u=l*r,d=0;d<s;++d)for(var f=o===z||o===T&&d%2||o===P&&!(d%2),p=0;p<c;++p){var h=b[f?c-p-1:p],m=h[1],y=l*d+(f?l-h[0]:h[0]),v=b[f?c-p:p-1];if(u<y){if(0!==p){var g=l*d+(f?l-v[0]:v[0]),k=(v[1]*(t=y-u)+m*(n=u-g))/(n+t);O(x,(i+l*r)/a,k)}break}if(y===u&&x[x.length-1][0]===u+i)break;O(x,(i+y)/a,m)}i&&x.unshift([0,x[0][1]]),b=x,x=[]}),b}(c.times,e.map(function(e){return e.state}));!function e(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];var a=[],r=y.isObject(n);if(u.forEach(function(e){var n=e[0],t=e[1],r=c.get.apply(c,[t].concat(i));y.isUndefined(r)||a.push([n,t,r])}),s[l.concat(i).join("///")]={isParent:r,item:c,names:l,properties:i,frames:a},r)for(var o in n)e.apply(void 0,[n[o]].concat(i,[o]))}(c.names)}function X(e){var a={};return function n(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[t.length-1],i=t.slice(1).map(function(e){return e.getId()});D(r)?(i.length&&(a[i.join("///")]={isParent:!0,item:r,names:[],properties:[],frames:[]}),r.forEach(function(e){n.apply(void 0,t.concat([e]))})):U(a,t,i,r)}(e),a}var W=!1;return function(r){function e(e,n){var t=r.call(this)||this;return t.maxTime=0,t.selectedProperty="",t.selectedTime=-1,t.ids={},e.finish(),t.scene=e,t.initStructure(e,n),t.initEditor(),t.initScroll(),t.initWheelZoom(),t.initDragKeyframes(),t.initClickProperty(),t.initController(),t.initDragValues(),t.initKeyController(),e.setTime(0),new B(t,n),t}!function(e,n){function t(){this.constructor=e}i(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}(e,r);var n=e.prototype;return n.getElement=function(){return this.structure.element},n.prev=function(){this.scene.setTime(this.scene.getTime()-.05)},n.next=function(){this.scene.setTime(this.scene.getTime()+.05)},n.finish=function(){this.scene.finish()},n.togglePlay=function(){var e=this.scene;"running"===e.getPlayState()?e.pause():e.play()},n.update=function(){var e=this.scene;this.timelineInfo=X(e);var n=Math.ceil(e.getDuration()),t=n,r=this.axes.get(["zoom"]).zoom,i=this.maxTime;this.maxTime=t;var a=this.ids,o=a.keyframesAreas[0];r*=5<i?n/i:1,this.axes.axm.set({zoom:r}),this.datadom.update(o,M(a,r,n,t));var s=q(a,this.timelineInfo,this.axes.get(["zoom"]).zoom,n,this.maxTime);this.datadom.update(a.scrollArea,s),e.setTime(e.getTime())},n.initController=function(){var n=this,i=this.ids,e=this.ids.playBtn.element,a=this.scene;e.addEventListener("click",function(e){n.togglePlay(),e.preventDefault()}),i.unselectedArea.element.addEventListener("click",function(e){n.select("",-1)}),i.prevBtn.element.addEventListener("click",function(e){n.prev(),e.preventDefault()}),i.nextBtn.element.addEventListener("click",function(e){n.next(),e.preventDefault()}),a.on("play",function(){x(e,"pause"),C(e,"play")}),a.on("paused",function(){x(e,"play"),C(e,"pause")}),new s(i.timeArea.element).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=i.timeArea.element.value,t=/(\d+):(\d+):(\d+)/g.exec(n);if(t){var r=60*parseFloat(t[1])+parseFloat(t[2])+parseFloat("0."+t[3]);a.setTime(r)}})},n.initKeyController=function(){var n=this,e=this.ids;window.addEventListener("blur",function(){C(e.timeline.element,"alt")}),this.keycon=(new s).keydown("space",function(e){e.inputEvent.preventDefault()}).keydown("left",function(e){n.prev()}).keydown("right",function(e){n.next()}).keyup("backspace",function(){n.removeKeyframe(n.selectedProperty)}).keydown("alt",function(){x(e.timeline.element,"alt")}).keyup("alt",function(){C(e.timeline.element,"alt")}).keyup("esc",function(){n.finish()}).keyup("space",function(){n.togglePlay()})},n.initStructure=function(e,n){this.timelineInfo=X(e);var t,r=Math.ceil(e.getDuration()),i=Math.ceil(r),a=i,o=this.ids;this.maxTime=a,W||(t={selector:"style.style",html:c},W=!0);var s={selector:".timeline",ref:function(e){o.timeline=e},children:[t,function(n){return{selector:".header_area.control_area",children:[{selector:".properties_area",ref:function(e){n.unselectedArea=e},children:{selector:".property"}},{selector:".values_area",children:{selector:".value"}},{selector:".keyframes_area",children:{selector:".keyframes",children:[{selector:"input.time_area",ref:function(e){n.timeArea=e},html:"???"},{selector:".play_control_area",children:[{ref:function(e){n.prevBtn=e},selector:".control.prev"},{ref:function(e){n.playBtn=e},selector:".control.play"},{ref:function(e){n.nextBtn=e},selector:".control.next"}]}]}}]}}(o),function(n,e,t,r){return{selector:".header_area",ref:function(e){n.keyframesScrollAreas=[],n.keyframesAreas=[],n.propertiesAreas=[]},children:[{ref:function(e){n.propertiesAreas[0]=e},selector:".properties_area",children:[{selector:".property",html:"Name"}]},{selector:".values_area",children:{selector:".value",html:"+"}},M(n,e,t,r)]}}(o,1,i,a),q(o,this.timelineInfo,1,i,a)]};this.datadom=new l(u,v),this.structure=this.datadom.render(s,n)},n.initScroll=function(){var e=this.ids.keyframesAreas,n=!1,t=e[0].element,r=e[1].element;t.addEventListener("scroll",function(){n?n=!1:(n=!0,r.scrollLeft=t.scrollLeft)}),r.addEventListener("scroll",function(){n?n=!1:(n=!0,t.scrollLeft=r.scrollLeft)})},n.initWheelZoom=function(){var t=this,r=this.ids,e=r.keyframesScrollAreas,n=e[0].element,i=e[1].element,a=new o({zoom:{range:[1,1/0]}},{},{zoom:1});a.connect("zoom",new o.PinchInput(i,{scale:.1,hammerManagerOptions:{touchAction:"auto"}})),a.on("hold",function(e){e.inputEvent&&e.inputEvent.preventDefault()}),a.on("change",function(e){var n=r.keyframesScrollAreas[0].dataset.width,t=e.pos.zoom*n*100;r.keyframesScrollAreas.forEach(function(e){e.element.style.width=t+"%"}),e.inputEvent&&e.inputEvent.preventDefault()}),this.axes=a,n.addEventListener("wheel",function(e){var n=e.deltaY;a.setBy({zoom:n/5e3}),!e.deltaX&&e.preventDefault()}),y.addEvent(i,"wheel",function(e){if(t.keycon.altKey){e.preventDefault();var n=e.deltaY;a.setBy({zoom:n/5e3})}})},n.select=function(e,n){var t=this.selectedProperty,r=this.selectedTime,i=this.ids,a=i.values,o=i.properties,s=i.keyframesList;if(this.selectedProperty=e,this.scene.pause(),t){var l=m(t,o);if(C(o[l].element,"select"),C(a[l].element,"select"),C(s[l].element,"select"),0<=r)i.keyframesContainers[l].children.forEach(function(e){e.datas.time===r&&C(e.element,"select")}),this.selectedTime=-1}var c=this.scene;if(e){document.activeElement&&document.activeElement.blur();var u=m(e,o);if(x(o[u].element,"select"),x(a[u].element,"select"),x(s[u].element,"select"),c=i.keyframesList[u].datas.item,0<=n)i.keyframesContainers[u].children.forEach(function(e){e.datas.time===n&&x(e.element,"select")}),this.selectedTime=n}this.trigger("select",{selectedItem:c,selectedProperty:this.selectedProperty,selectedTime:this.selectedTime,prevSelectedProperty:t,prevSelectedTime:r})},n.initClickProperty=function(){var a=this,o=this.ids;o.propertiesAreas[1].element.addEventListener("click",function(e){var n=o.properties.map(function(e){return e.element}),t=(n.length,k(e.target,function(e){return b(e,"arrow")})),r=k(e.target,function(e){return b(e,"property")});if(r){var i=n.indexOf(r);-1!==i&&(t||a.select(n[i].dataset.key))}})},n.setInputs=function(e){var n=this.ids.valuesArea.element;for(var t in e)n.querySelector('[data-key="'+t+'"] input').value=e[t]},n.moveCursor=function(e){var n=this.ids.cursors,t=this.maxTime,r="calc("+100*e/t+"% + "+(15-30*e/t)+"px)";n.forEach(function(e){e.element.style.left=r})},n.initDragKeyframes=function(){var s=this,l=this.ids,i=l.scrollArea,a=l.timeArea,e=l.cursors,o=l.keyframesAreas,c=l.keyframesScrollAreas,u=this.scene;u.on("animate",function(e){var n=e.time;s.moveCursor(n),s.setInputs(function e(n,t){for(var r in void 0===t&&(t={}),n){var i=n[r];if(y.isObject(i)){var a=e(i.constructor.prototype.toCSS?i.get():i);for(var o in a)t[r+"///"+o]=a[o]}else t[r]=i}return t}(e.frames));var t=h(Math.floor(n/60),2),r=h(Math.floor(n%60),2),i=h(Math.floor(n%1*100),3,!0);a.element.value=t+":"+r+":"+i});var d=function(e){var n=c[1].element.getBoundingClientRect(),t=n.width-30,r=n.left+15,i=Math.min(t,Math.max(e-r,0))/t,a=s.maxTime*i;return a=Math.round(20*a)/20},f=function(e,n,t){var r=L(l.keyframesList.map(function(e){return e.element}),t);-1!==r&&s.addKeyframe(r,d(n))};p.drag(e[0].element,{dragstart:function(e){e.inputEvent.stopPropagation()},drag:function(e){!function(e){u.setTime(d(e))}(e.clientX)},container:window}),c.forEach(function(e){var n=e.element;p.drag(n,{container:window,drag:function(e){var n=e.deltaX,t=e.deltaY,r=e.inputEvent;o[1].element.scrollLeft-=n,i.element.scrollTop-=t,r.preventDefault()},dragend:function(e){var n=e.isDrag,t=e.clientX,r=e.clientY,i=e.inputEvent;!n&&function(e,n,t){var r=k(e.target,function(e){return b(e,"keyframe")}),i=r?parseFloat(r.getAttribute("data-time")):d(n);u.setTime(i);var a=l.keyframesList,o=L(a.map(function(e){return e.element}),t);-1<o&&s.select(a[o].dataset.key,i),e.preventDefault()}(i,t,r),function(e,n,t,r,i){var a=y.now();e||(S===t&&j===r&&a-I<=500&&i(n,t,r),S=t,j=r,I=a)}(n,i,t,r,f)}})})},n.initDragValues=function(){var t,n=this,r=null;p.drag(this.ids.valuesArea.element,{container:window,dragstart:function(e){if(r=e.inputEvent.target,t=r.value,console.log(n.keycon.altKey,k(r,function(e){return"INPUT"===e.nodeName})),!n.keycon.altKey||!k(r,function(e){return"INPUT"===e.nodeName}))return!1},drag:function(n){var e=t.replace(/-?\d+/g,function(e){return""+(parseFloat(e)+Math.round(n.distX/2))});r.value=e},dragend:function(e){n.edit(r,r.value)}})},n.addKeyframe=function(e,n){var t=this.ids.keyframesList,r=t[e].dataset.key,i=t[e].datas;i.item,i.properties;this.select(r,n);var a=this.ids.values[e].children.element.value;this.editKeyframe(e,a)},n.removeKeyframe=function(e){var n=this.timelineInfo[e];if(e&&n&&!D(n.item)){var t=n.properties,r=n.item;r.remove.apply(r,[r.getIterationTime()].concat(t)),this.update()}},n.editKeyframe=function(e,n){var t=this.ids;if(!("1"===t.properties[e].dataset.object)){var r=t.keyframesList[e].datas,i=r.item,a=r.properties;console.log(a),i.set.apply(i,[i.getIterationTime()].concat(a,[n])),this.update()}},n.restoreKeyframes=function(){this.scene.setTime(this.scene.getTime())},n.edit=function(e,n){var t=k(e,function(e){return b(e,"value")});if(t){var r=this.ids.values.map(function(e){return e.element}).indexOf(t);-1!==r&&this.editKeyframe(r,n)}},n.initEditor=function(){var t=this,e=this.ids.valuesArea.element;new s(e).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=e.inputEvent.target;t.edit(n,n.value)}).keyup("esc",function(e){e.inputEvent.target.blur()}),e.addEventListener("focusout",function(e){t.restoreKeyframes()})},e}(e)});
//# sourceMappingURL=timeline.min.js.map
