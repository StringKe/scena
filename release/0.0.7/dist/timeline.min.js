/*
Copyright (c) 2019 Daybrush
name: @scenejs/timeline
license: MIT
author: Daybrush
repository: git+https://github.com/daybrush/scenejs-timeline.git
version: 0.0.7
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@daybrush/utils"),require("@daybrush/drag"),require("@egjs/axes"),require("keycon"),require("data-dom"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["@daybrush/utils","@daybrush/drag","@egjs/axes","keycon","data-dom","@egjs/component"],t):(e=e||self).Timeline=t(e.utils,e.utils,e.eg.Axes,e.KeyController,e.DataDOM,e.Component)}(this,function(y,r,o,s,l,e){"use strict";var a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};var c=function(){return(c=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},p="scenejs_editor_",i="\n.item_info {\n    position: fixed;\n    right: 0;\n    top: 0;\n    width: 200px;\n    background: #000;\n}\n.options_area {\n\n}\n.option_area {\n    position: relative;\n    border-bottom: 1px solid #777;\n    box-sizing: border-box;\n    white-space: nowrap;\n    background: rgba(90, 90, 90, 0.7);\n    font-size: 13px;\n    font-weight: bold;\n    color: #eee;\n    display: flex;\n}\n.option_name, .option_value {\n    width: 50%;\n    height: 30px;\n    line-height: 20px;\n    box-sizing: border-box;\n    padding: 5px;\n}\n.option_name {\n    border-right: 1px solid #999;\n}\n.option_value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n}\n".replace(/\.([^{,\s\d.]+)/g,"."+p+"$1"),d='\n.timeline {\n  position: fixed;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  font-size: 0;\n  background: #000;\n  display: flex;\n  flex-direction: column;\n}\n.header_area, .scroll_area {\n   width: 100%;\n   position: relative;\n  display: flex;\n  -webkit-align-items: flex-start;\n  align-items: flex-start;\n}\n.header_area {\n  position: relative;\n  z-index: 10;\n  top: 0;\n  height: 30px;\n  min-height: 30px;\n}\n.header_area .keyframes {\n  padding: 0px;\n}\n.header_area .properties_area,\n.header_area .keyframes_area,\n.header_area .values_area,\n.header_area .keyframes_scroll_area {\n    height: 100%;\n}\n.header_area .property, .header_area .value, .header_area .keyframes {\n  height: 100%;\n}\n.header_area .property {\n    line-height: 30px;\n}\n.value .add {\n    text-align: center;\n    color: #fff;\n    line-height: 30px;\n    font-weight: bold;\n    font-size: 20px;\n    cursor: pointer;\n}\n.header_area .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.header_area .keyframe_cursor {\n    position: absolute;\n    border-top: 10px solid #4af;\n    border-left: 6px solid transparent;\n    border-right: 6px solid transparent;\n    width: 0;\n    height: 0;\n    bottom: 0;\n    top: auto;\n    background: none;\n    cursor: pointer;\n}\n.control_area .keyframes {\n    padding-left: 10px;\n}\n.play_control_area {\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n}\n.play_control_area .control {\n    position: relative;\n    display: inline-block;\n    vertical-align: middle;\n    color: white;\n    margin: 0px 15px;\n}\n.play {\n    border-left: 14px solid white;\n    border-top: 8px solid transparent;\n    border-bottom: 8px solid transparent;\n}\n.pause {\n    border-left: 4px solid #fff;\n    border-right: 4px solid #fff;\n    width: 6px;\n    height: 16px;\n}\n.prev {\n    border-right: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.prev:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    right: 100%;\n    transform: translate(0, -50%);\n    background: white;\n}\n.next {\n    border-left: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.next:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    transform: translate(0, -50%);\n    background: white;\n}\n.keytime {\n  position: relative;\n  display: inline-block;\n  height: 100%;\n  font-size: 13px;\n  font-weight: bold;\n  color: #777;\n}\n.keytime:last-child {\n  max-width: 0px;\n}\n.keytime span {\n  position: absolute;\n  line-height: 1;\n  bottom: 12px;\n  display: inline-block;\n  transform: translate(-50%);\n  color: #eee;\n}\n.keytime .graduation {\n  position: absolute;\n  bottom: 0;\n  width: 1px;\n  height: 10px;\n  background: #777;\n  transform: translate(-50%);\n}\n.keytime .graduation.half {\n  left: 50%;\n  height: 7px;\n}\n.keytime .graduation.quarter {\n  left: 25%;\n  height: 5px;\n}\n.keytime .graduation.quarter3 {\n  left: 75%;\n  height: 5px;\n}\n.scroll_area {\n  position: relative;\n  width: 100%;\n  height: calc(100% - 60px);\n  overflow: auto;\n}\n.properties_area, .keyframes_area, .values_area {\n  display: inline-block;\n  position: relative;\n  font-size: 16px;\n  overflow: auto;\n}\n\n.properties_area::-webkit-scrollbar, .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.properties_area {\n  width: 30%;\n  max-width: 200px;\n  box-sizing: border-box;\n}\n.values_area {\n    width: 50px;\n    min-width: 50px;\n    display: inline-block;\n    border-right: 1px solid #999;\n    box-sizing: border-box;\n}\n.value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n    text-align: center;\n}\n.value {\n\n}\n.alt .value input {\n    cursor: ew-resize;\n}\n.value[data-object="1"] input {\n    display: none;\n}\n.properties_scroll_area {\n  display: inline-block;\n  min-width: 100%;\n}\n.keyframes_area {\n  flex: 1;\n}\n.keyframes_scroll_area {\n  position: relative;\n  min-width: 300px;\n}\n.keyframes, .property, .value {\n  position: relative;\n  height: 30px;\n  line-height: 30px;\n  border-bottom: 1px solid #777;\n  box-sizing: border-box;\n  white-space: nowrap;\n  background: rgba(90, 90, 90, 0.7);\n  z-index: 1;\n}\n\n.property {\n  padding-left: 10px;\n  box-sizing: border-box;\n  font-size: 13px;\n  font-weight: bold;\n  color: #eee;\n}\n.property .remove {\n    position: absolute;\n    display: inline-block;\n    cursor: pointer;\n    width: 18px;\n    height: 18px;\n    top: 0;\n    bottom: 0;\n    right: 10px;\n    margin: auto;\n    border-radius: 50%;\n    border: 2px solid #fff;\n    vertical-align: middle;\n    display: none;\n    margin-left: 10px;\n    box-sizing: border-box;\n}\n.property .remove:before, .property .remove:after {\n    position: absolute;\n    content: "";\n    width: 8px;\n    height: 2px;\n    border-radius: 1px;\n    background: #fff;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    margin: auto;\n}\n.property .remove:before {\n    transform: rotate(45deg);\n}\n.property .remove:after {\n    transform: rotate(-45deg);\n}\n.property:hover .remove {\n    display: inline-block;\n}\n\n[data-item="1"], [data-item="1"] .add {\n    height: 30px;\n    line-height: 30px;\n}\n.time_area {\n    font-size: 13px;\n    color: #4af;\n    line-height: 30px;\n    font-weight: bold;\n    height: 100%;\n    line-height: 30px;\n    border: 0;\n    background: transparent;\n    outline: 0;\n}\n.time_area:after {\n    content: "s";\n}\n.property .arrow {\n    position: relative;\n    display: inline-block;\n    margin-right: 5px;\n    width: 0;\n    vertical-align: middle;\n    cursor: pointer;\n    border-top: 6px solid #eee;\n    border-left: 4px solid transparent;\n    border-right: 4px solid transparent;\n}\n.property[data-fold="1"] .arrow {\n    border-top: 4px solid transparent;\n    border-bottom: 4px solid transparent;\n    border-right: 0;\n    border-left: 6px solid #eee;\n    margin-left: 2px;\n}\n.property[data-object="0"] .arrow {\n    display: none;\n}\n.property.fold, .keyframes.fold, .value.fold {\n    display: none;\n}\n.property.select, .value.select, .keyframes.select {\n    background: rgba(120, 120, 120, 0.7);\n}\n.keyframes {\n\n}\n.keyframe_delay {\n  position: absolute;\n  height: 100%;\n  top: 0;\n  left: 0;\n  background: #4af;\n  opacity: 0.2;\n  z-index: 0;\n}\n.keyframe_line {\n  position: absolute;\n  height: 8px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  background: #666;\n  z-index: 0;\n}\n.keyframe {\n  position: absolute;\n  font-size: 0px;\n  width: 12px;\n  height: 12px;\n  top: 0px;\n  bottom: 0px;\n  margin: auto;\n  background: #fff;\n  border: 2px solid #383838;\n  border-radius: 2px;\n  box-sizing: border-box;\n  transform: translate(-50%) rotate(45deg);\n  z-index: 1;\n  cursor: pointer;\n}\n.keyframe[data-no="1"] {\n    opacity: 0.2;\n}\n.select .keyframe {\n    border-color: #555;\n}\n.keyframe.select {\n    background: #4af;\n}\n.keyframes_container, .line_area {\n  position: relative;\n  width: calc(100% - 30px);\n  left: 15px;\n  height: 100%;\n}\n.line_area {\n  position: absolute;\n  top: 0;\n  z-index: 0;\n}\n.keyframe_cursor {\n  position: absolute;\n  top: 0;\n  z-index: 1;\n  background: #4af;\n  width: 1px;\n  height: 100%;\n  left: 15px;\n  transform: translate(-50%);\n}\n.division_line {\n  position: absolute;\n  background: #333;\n  width: 1px;\n  height: 100%;\n  transform: translate(-50%);\n}\n'.replace(/\.([^{,\s\d.]+)/g,"."+p+"$1"),_="direction",w="iterationCount",A="delay",E="playSpeed",T="alternate",I="reverse",z="alternate-reverse";function f(e,t,n){var r=(""+e).length,i=[];n&&i.push(e);for(var a=r;a<t;++a)i.push(0);return n||i.push(e),i.join("")}function u(e,t){for(var n in t)e.style[n]=t[n]}function m(t,e){return e.findIndex(function(e){return e.dataset.key===t})}function h(e){var t=e.selector,n=e.dataset,r=e.attr,i=e.style,a=e.html,o=t.match(/\.([^.#\s])+/g)||[],s=(t.match(/^[^.#\s]+/g)||[])[0]||"div",l=(t.match(/#[^.#\s]+/g)||[])[0]||"",c=document.createElement(s);if(l&&(c.id=l.replace(/^#/g,"")),c.className=o.map(function(e){return""+p+e.replace(/^\./g,"")}).join(" "),n)for(var d in n)c.setAttribute("data-"+d,n[d]);if(r)for(var d in r)c.setAttribute(d,r[d]);return i&&u(c,i),a&&(c.innerHTML=a),c}function v(e,t){var n=t.dataset,r=t.attr,i=t.style,a=t.html,o=t.element;if(n)for(var s in n)o.setAttribute("data-"+s,n[s]);if(r)for(var s in r)o.setAttribute(s,r[s]);i&&u(o,i),e.html!==t.html&&(o.innerHTML=a)}function g(t){return"object"==typeof t?Array.isArray(t)?"["+t.join(", ")+"]":"{"+function(e){var t=[];for(var n in e)t.push(n);return t}(t).map(function(e){return e+": "+g(t[e])}).join(", ")+"}":t}function b(e,t){for(var n=e;n&&n!==document.body;){if(t(n))return n;n=n.parentNode}return null}function k(e,t){return y.hasClass(e,""+p+t)}function x(e,t){return y.addClass(e,""+p+t)}function P(e,t){return y.removeClass(e,""+p+t)}function C(e){return!!e.constructor.prototype.getItem}function L(e,t){for(var n=e.length,r=0;r<n;++r){var i=e[r].getBoundingClientRect(),a=i.top,o=a+i.height;if(a<=t&&t<o)return r}return-1}var D=0,j=-1,S=-1;function M(t,e,n,r){return{ref:function(e){t.keyframesAreas[0]=e},selector:".keyframes_area",children:{style:{minWidth:50*r+"px",width:Math.min(n?r/n:1,2)*e*100+"%"},dataset:{width:Math.min(n?r/n:1,2)},ref:function(e){t.keyframesScrollAreas[0]=e},selector:".keyframes_scroll_area",children:{ref:function(e){t.cursors=[]},selector:".keyframes",children:[{ref:function(e){t.keytimesContainer=e},selector:".keyframes_container",children:function(e){for(var t=[],n=0;n<=e;++n)t.push({key:n,dataset:{time:n},selector:".keytime",style:{width:100/e+"%"},children:[{selector:"span",html:""+n},{selector:".graduation.start"},{selector:".graduation.quarter"},{selector:".graduation.half"},{selector:".graduation.quarter3"}]});return t}(r)},{selector:".keyframe_cursor",ref:function(e){t.cursors[0]=e}}]}}}}function K(t,e,n,r,i){var a=Math.min(r?i/r:1,2);return{ref:function(e){t.keyframesAreas[1]=e},selector:".keyframes_area",children:{style:{minWidth:50*i+"px",width:a*n*100+"%"},dataset:{width:a},ref:function(e){t.keyframesScrollAreas[1]=e},selector:".keyframes_scroll_area",children:function(t,e,n){return e.concat([{key:"cursor",selector:".keyframe_cursor",ref:function(e){t.cursors[1]=e}},{key:"lineArea",ref:function(e){t.lineArea=e},selector:".line_area",children:function(e){for(var t=[],n=0;n<=e;++n)t.push({key:n,selector:".division_line",style:{left:100/e*n+"%"}});return t}(n)}])}(t,e,i)}}}function F(e,p){var u=[],f=e.item.getDuration(),m=e.frames,h=[];return m.map(function(e,t){var n=e[0],r=e[1],i=e[2],a=g(i);if(m[t+1]){var o=m[t+1],s=o[0],l=o[1],c=o[2],d=g(c);(0===r&&0===l||r===f&&l===f)&&h.push(function(e,t,n){return{selector:".keyframe_delay",key:"delay"+e+","+t,datas:{time:-1},style:{left:e/n*100+"%",width:(t-e)/n*100+"%"}}}(n,s,p)),y.isUndefined(i)||y.isUndefined(c)||a===d||u.push({selector:".keyframe_line",key:n+","+s,datas:{time:n+","+s,from:n,to:s},style:{left:n/p*100+"%",width:(s-n)/p*100+"%"}})}return{key:n,selector:".keyframe",dataset:{time:n},datas:{time:n,iterationTime:r,value:a},style:{left:n/p*100+"%"},html:n+" "+a}}).concat(h,u)}function O(t,e,n,r,i){var a=function(n,e,t){var r=[];for(var i in e){var a=e[i],o=F(a,t);r.push({ref:function(e,t){n.keyframesList[t]=e,n.keyframesContainers[t]=e.children},selector:".keyframes",key:i,dataset:{item:a.isItem?"1":"0",key:i},datas:a,children:{selector:".keyframes_container",children:o}})}return r}(t,e,i);return{ref:function(e){t.scrollArea=e,t.keyframesList=[],t.keyframesContainers=[]},selector:".scroll_area",children:[{ref:function(e){t.propertiesAreas[1]=e,t.properties=[]},selector:".properties_area",children:[{selector:".properties_scroll_area",children:function(n,e){var t=[];for(var r in e){var i=e[r],a=r.split("///"),o=a.length,s=a[o-1];t.push({ref:function(e,t){n.properties[t]=e},key:r,selector:".property",dataset:{key:r,object:i.isParent?"1":"0",item:i.isItem?"1":"0"},datas:i,style:{paddingLeft:10+20*(o-1)+"px"},children:[{selector:".arrow"},{selector:"span",html:s},{selector:".remove"}]})}return t}(t,e)}]},{ref:function(e){t.valuesArea=e,t.values=[]},selector:".values_area",children:function(n,e){var t=[];for(var r in e){var i=e[r],a=i.frames;t.push({ref:function(e,t){n.values[t]=e},key:r,selector:".value",dataset:{key:r,item:i.isItem?"1":"0",object:i.isParent?"1":"0"},datas:i,children:i.isParent?{key:"add",selector:".add",html:"+"}:{key:"input",selector:"input",attr:{value:a[0]?a[0][1]:""}}})}return t}(t,e)},K(t,a,n,r,i)]}}function t(e,t){return{selector:".option_area",children:[{selector:".option_name",html:e},{selector:".option_value",dataset:{option:e},children:{selector:"input",dataset:{option:e},ref:function(e){e.element.value=y.isUndefined(t)?"":t}}}]}}function q(e){return[t("delay",e&&e.getDelay()),t("easing",e&&e.getEasingName()),t("iterationCount",e&&e.getIterationCount()),t("playSpeed",e&&e.getPlaySpeed()),t("fillMode",e&&e.getFillMode()),t("direction",e&&e.getDirection()),t("duration",e&&e.getDuration()),t("lastFrame",e&&e.getDuration())]}var B=function(){function e(e,t){var n=this;this.timeline=e,this.select=function(e){n.selectedItem=e.selectedItem,n.update()},e.on("select",this.select),this.datadom=new l(h,v),this.selectedItem=e.scene,this.infoArea=this.datadom.render({selector:".item_info",children:[{selector:"style",html:i},{ref:function(e){n.optionArea=e},selector:".options_area",children:q(e.scene)}]},t),this.init()}var t=e.prototype;return t.update=function(){this.datadom.update(this.optionArea.children,q(this.selectedItem),this.optionArea)},t.init=function(){var o=this;new s(this.infoArea.element).keydown(function(e){e.inputEvent.stopPropagation()}).keyup(function(e){e.inputEvent.stopPropagation()}).keyup("enter",function(e){var t=o.selectedItem;if(o.selectedItem){var n=b(e.inputEvent.target,function(e){return"INPUT"===e.nodeName});if(n){var r=n.getAttribute("data-option"),i=n.value;if("delay"===r)t.setDelay(parseFloat(i));else if("lastFrame"===r){var a=parseFloat(i);(function(e){return!!e.constructor.prototype.getFrame})(t)&&t.getDuration()<a&&t.newFrame(a)}else"playSpeed"===r?t.setPlaySpeed(parseFloat(i)):"direction"===r?t.setDirection(i):"iterationCount"===r?t.setIterationCount("infinite"===i?i:parseFloat(i)):"easing"===r&&t.setEasing(i);o.timeline.update(),o.update()}}})},e}(),n=1e6;function N(e){return Math.round(e*n)/n}function U(e,t,n){var r=e[e.length-1];(!r||r[0]!==t||r[1]!==n)&&e.push([N(t),N(n)])}function X(c,e,d,p){p.update();var u=function(e,t){if(!e.length)return[];var k=e.map(function(e){return[e,e]}),x=[];return 0!==k[0][0]&&t[t.length-1][A]&&k.unshift([0,0]),t.forEach(function(e){for(var t,n,r=e[w],i=e[A],a=e[E],o=e[_],s=Math.ceil(r),l=k[k.length-1][0],c=k.length,d=l*r,p=0;p<s;++p)for(var u=o===I||o===T&&p%2||o===z&&!(p%2),f=0;f<c;++f){var m=k[u?c-f-1:f],h=m[1],y=l*p+(u?l-m[0]:m[0]),v=k[u?c-f:f-1];if(d<y){if(0!==f){var g=l*p+(u?l-v[0]:v[0]),b=(v[1]*(n=y-d)+h*(t=d-g))/(t+n);U(x,(i+l*r)/a,b)}break}if(y===d&&x[x.length-1][0]===d+i)break;U(x,(i+y)/a,h)}i&&x.unshift([0,x[0][1]]),k=x,x=[]}),k}(p.times,e.map(function(e){return e.state}));!function e(t){for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];var a=[],r=y.isObject(t),o=0===i.length;u.forEach(function(e){var t=e[0],n=e[1],r=p.get.apply(p,[n].concat(i));y.isUndefined(r)&&i.length||a.push([t,n,r])});var s=d.concat(i).join("///");if(c[s]={key:s,parentItem:null,isParent:r,isItem:o,item:p,names:d,properties:i,frames:a},r)for(var l in t)e.apply(void 0,[t[l]].concat(i,[l]))}(p.names)}function W(e){var s={};return function t(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var r=n.length,i=n[r-1],a=n.slice(1).map(function(e){return e.getId()});if(C(i)){if(a.length){var o=a.join("///");s[o]={key:o,isItem:!0,isParent:!0,parentItem:n[r-2],item:i,names:[],properties:[],frames:[]}}i.forEach(function(e){t.apply(void 0,n.concat([e]))})}else X(s,n,a,i)}(e),s}var Y=!1;return function(i){function e(e,t,n){void 0===n&&(n={});var r=i.call(this)||this;return r.maxTime=0,r.selectedProperty="",r.selectedTime=-1,r.ids={},r.options=c({keyboard:!0},n),e.finish(),r.scene=e,r.initStructure(e,t),r.initEditor(),r.initScroll(),r.initWheelZoom(),r.initDragKeyframes(),r.initClickProperty(),r.initController(),r.initDragValues(),r.initKeyController(),e.setTime(0),new B(r,t),r}!function(e,t){function n(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(e,i);var t=e.prototype;return t.getElement=function(){return this.structure.element},t.prev=function(){this.scene.setTime(this.scene.getTime()-.05)},t.next=function(){this.scene.setTime(this.scene.getTime()+.05)},t.finish=function(){this.scene.finish()},t.togglePlay=function(){var e=this.scene;"running"===e.getPlayState()?e.pause():e.play()},t.update=function(){var e=this.scene;this.timelineInfo=W(e);var t=Math.ceil(e.getDuration()),n=t,r=this.axes.get(["zoom"]).zoom,i=this.maxTime;this.maxTime=n;var a=this.ids,o=a.keyframesAreas[0];r*=5<i?t/i:1,this.axes.axm.set({zoom:r}),this.datadom.update(o,M(a,r,t,n));var s=O(a,this.timelineInfo,this.axes.get(["zoom"]).zoom,t,this.maxTime);this.datadom.update(a.scrollArea,s),e.setTime(e.getTime())},t.initController=function(){var n=this,i=this.ids,e=this.ids.playBtn.element,a=this.scene;this.ids.addItem.element.addEventListener("click",function(e){var t=prompt("Add Item");t&&(n.scene.newItem(t),n.update())}),e.addEventListener("click",function(e){n.togglePlay(),e.preventDefault()}),i.unselectedArea.element.addEventListener("click",function(e){n.select("",-1)}),i.prevBtn.element.addEventListener("click",function(e){n.prev(),e.preventDefault()}),i.nextBtn.element.addEventListener("click",function(e){n.next(),e.preventDefault()}),a.on("play",function(){x(e,"pause"),P(e,"play")}),a.on("paused",function(){x(e,"play"),P(e,"pause")}),this.options.keyboard&&new s(i.timeArea.element).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var t=i.timeArea.element.value,n=/(\d+):(\d+):(\d+)/g.exec(t);if(n){var r=60*parseFloat(n[1])+parseFloat(n[2])+parseFloat("0."+n[3]);a.setTime(r)}})},t.initKeyController=function(){var t=this,e=this.ids;window.addEventListener("blur",function(){P(e.timeline.element,"alt")}),this.keycon=(new s).keydown("alt",function(){x(e.timeline.element,"alt")}).keyup("alt",function(){P(e.timeline.element,"alt")}),this.options.keyboard&&this.keycon.keydown("space",function(e){e.inputEvent.preventDefault()}).keydown("left",function(e){t.prev()}).keydown("right",function(e){t.next()}).keyup("backspace",function(){t.removeKeyframe(t.selectedProperty)}).keyup("esc",function(){t.finish()}).keyup("space",function(){t.togglePlay()})},t.initStructure=function(e,t){this.timelineInfo=W(e);var n,r=Math.ceil(e.getDuration()),i=Math.ceil(r),a=i,o=this.ids;this.maxTime=a,Y||(n={selector:"style.style",html:d},Y=!0);var s={selector:".timeline",ref:function(e){o.timeline=e},children:[n,function(t){return{selector:".header_area.control_area",children:[{selector:".properties_area",ref:function(e){t.unselectedArea=e},children:{selector:".property"}},{selector:".values_area",children:{selector:".value"}},{selector:".keyframes_area",children:{selector:".keyframes",children:[{selector:"input.time_area",ref:function(e){t.timeArea=e},html:"???"},{selector:".play_control_area",children:[{ref:function(e){t.prevBtn=e},selector:".control.prev"},{ref:function(e){t.playBtn=e},selector:".control.play"},{ref:function(e){t.nextBtn=e},selector:".control.next"}]}]}}]}}(o),function(t,e,n,r){return{selector:".header_area",ref:function(e){t.keyframesScrollAreas=[],t.keyframesAreas=[],t.propertiesAreas=[]},children:[{ref:function(e){t.propertiesAreas[0]=e},selector:".properties_area",children:[{selector:".property",html:"Name"}]},{selector:".values_area",children:{selector:".value",children:{key:"add",selector:".add",html:"+",ref:function(e){t.addItem=e}}}},M(t,e,n,r)]}}(o,1,i,a),O(o,this.timelineInfo,1,i,a)]};this.datadom=new l(h,v),this.structure=this.datadom.render(s,t)},t.initScroll=function(){var e=this.ids.keyframesAreas,t=!1,n=e[0].element,r=e[1].element;n.addEventListener("scroll",function(){t?t=!1:(t=!0,r.scrollLeft=n.scrollLeft)}),r.addEventListener("scroll",function(){t?t=!1:(t=!0,n.scrollLeft=r.scrollLeft)})},t.initWheelZoom=function(){var n=this,r=this.ids,e=r.keyframesScrollAreas,t=e[0].element,i=e[1].element,a=new o({zoom:{range:[1,1/0]}},{},{zoom:1});a.connect("zoom",new o.PinchInput(i,{scale:.1,hammerManagerOptions:{touchAction:"auto"}})),a.on("hold",function(e){e.inputEvent&&e.inputEvent.preventDefault()}),a.on("change",function(e){var t=r.keyframesScrollAreas[0].dataset.width,n=e.pos.zoom*t*100;r.keyframesScrollAreas.forEach(function(e){e.element.style.width=n+"%"}),e.inputEvent&&e.inputEvent.preventDefault()}),this.axes=a,t.addEventListener("wheel",function(e){var t=e.deltaY;a.setBy({zoom:t/5e3}),!e.deltaX&&e.preventDefault()}),y.addEvent(i,"wheel",function(e){if(n.keycon.altKey){e.preventDefault();var t=e.deltaY;a.setBy({zoom:t/5e3})}})},t.select=function(e,t){var n=this.selectedProperty,r=this.selectedTime,i=this.ids,a=i.values,o=i.properties,s=i.keyframesList;if(this.selectedProperty=e,this.scene.pause(),n){var l=m(n,o);if(P(o[l].element,"select"),P(a[l].element,"select"),P(s[l].element,"select"),0<=r)i.keyframesContainers[l].children.forEach(function(e){e.datas.time===r&&P(e.element,"select")}),this.selectedTime=-1}var c=this.scene;if(e){document.activeElement&&document.activeElement.blur();var d=m(e,o);if(x(o[d].element,"select"),x(a[d].element,"select"),x(s[d].element,"select"),c=i.keyframesList[d].datas.item,0<=t)i.keyframesContainers[d].children.forEach(function(e){e.datas.time===t&&x(e.element,"select")}),this.selectedTime=t}this.trigger("select",{selectedItem:c,selectedProperty:this.selectedProperty,selectedTime:this.selectedTime,prevSelectedProperty:n,prevSelectedTime:r})},t.initClickProperty=function(){var s=this,l=this.ids;l.propertiesAreas[1].element.addEventListener("click",function(e){var t=l.properties.map(function(e){return e.element}),n=(t.length,b(e.target,function(e){return k(e,"arrow")})),r=b(e.target,function(e){return k(e,"remove")}),i=b(e.target,function(e){return k(e,"property")});if(i){var a=t.indexOf(i);if(-1!==a){var o=l.properties[a];r?s.remove(o.datas):(s.select(o.dataset.key),n&&s.fold(a))}}})},t.setInputs=function(e){var t=this.ids.valuesArea.element;for(var n in e)t.querySelector('[data-key="'+n+'"] input').value=e[n]},t.moveCursor=function(e){var t=this.ids.cursors,n=this.maxTime,r="calc("+100*e/n+"% + "+(15-30*e/n)+"px)";t.forEach(function(e){e.element.style.left=r})},t.initDragKeyframes=function(){var s=this,l=this.ids,i=l.scrollArea,a=l.timeArea,e=l.cursors,o=l.keyframesAreas,c=l.keyframesScrollAreas,d=this.scene;d.on("animate",function(e){var t=e.time;s.moveCursor(t),s.setInputs(function e(t,n){for(var r in void 0===n&&(n={}),t){var i=t[r];if(y.isObject(i)){var a=e(i.constructor.prototype.toCSS?i.get():i);for(var o in a)n[r+"///"+o]=a[o]}else n[r]=i}return n}(e.frames));var n=f(Math.floor(t/60),2),r=f(Math.floor(t%60),2),i=f(Math.floor(t%1*100),3,!0);a.element.value=n+":"+r+":"+i});var p=function(e){var t=c[1].element.getBoundingClientRect(),n=t.width-30,r=t.left+15,i=Math.min(n,Math.max(e-r,0))/n,a=s.maxTime*i;return a=Math.round(20*a)/20},u=function(e,t,n){var r=L(l.keyframesList.map(function(e){return e.element}),n);-1!==r&&s.addKeyframe(r,p(t))};r.drag(e[0].element,{dragstart:function(e){e.inputEvent.stopPropagation()},drag:function(e){!function(e){d.setTime(p(e))}(e.clientX)},container:window}),c.forEach(function(e){var t=e.element;r.drag(t,{container:window,drag:function(e){var t=e.deltaX,n=e.deltaY,r=e.inputEvent;o[1].element.scrollLeft-=t,i.element.scrollTop-=n,r.preventDefault()},dragend:function(e){var t=e.isDrag,n=e.clientX,r=e.clientY,i=e.inputEvent;!t&&function(e,t,n){var r=b(e.target,function(e){return k(e,"keyframe")}),i=r?parseFloat(r.getAttribute("data-time")):p(t);d.setTime(i);var a=l.keyframesList,o=L(a.map(function(e){return e.element}),n);-1<o&&s.select(a[o].dataset.key,i),e.preventDefault()}(i,n,r),function(e,t,n,r,i){var a=y.now();e||(j===n&&S===r&&a-D<=500&&i(t,n,r),j=n,S=r,D=a)}(t,i,n,r,u)}})})},t.initDragValues=function(){var n,s=this,l=this.ids,e=l.valuesArea.element,c=null;y.addEvent(e,"click",function(e){var t=b(c,function(e){return k(e,"add")});if(t){var n=m(t.parentElement.getAttribute("data-key"),l.values);if(!(n<0)){var r=prompt("add property");if(r){var i=l.properties[n].datas,a=i.properties.slice(),o=i.item;o.set.apply(o,[o.getIterationTime()].concat(a,[r,0])),s.update()}}}}),r.drag(e,{container:window,dragstart:function(e){if(c=e.inputEvent.target,n=c.value,!s.keycon.altKey||!b(c,function(e){return"INPUT"===e.nodeName}))return!1},drag:function(t){var e=n.replace(/-?\d+/g,function(e){return""+(parseFloat(e)+Math.round(t.distX/2))});c.value=e},dragend:function(e){s.edit(c,c.value)}})},t.addKeyframe=function(e,t){var n=this.ids.keyframesList,r=n[e].dataset.key,i=n[e].datas;i.item,i.properties;this.select(r,t);var a=this.ids.values[e].children.element.value;this.editKeyframe(e,a)},t.fold=function(e){var t,n=this.ids,r=n.properties,i=n.values,a=n.keyframesList,o=r[e],s=r.length;for(t=e;t<s&&0===r[t].datas.key.indexOf(o.datas.key);++t);var l=r.slice(e+1,t),c=i.slice(e+1,t),d=a.slice(e+1,t),p=o.element,u="1"===p.getAttribute("data-fold");p.setAttribute("data-fold",u?"0":"1");var f=u?P:x;l.forEach(function(e,t){f(e.element,"fold"),f(c[t].element,"fold"),f(d[t].element,"fold")})},t.remove=function(e){var t=e.key,n=e.isItem,r=e.parentItem,i=e.item,a=e.properties;if(n){var o=null;r.forEach(function(e,t){e!==i||(o=t)}),null!=o&&r.removeItem(o)}else{i.times.forEach(function(e){var t;(t=i).remove.apply(t,[e].concat(a))})}this.selectedProperty===t&&(this.selectedProperty="",this.selectedTime=-1),this.update()},t.removeKeyframe=function(e){var t=this.timelineInfo[e];if(e&&t&&!C(t.item)){var n=t.properties,r=t.item;r.remove.apply(r,[r.getIterationTime()].concat(n)),this.update()}},t.editKeyframe=function(e,t){var n=this.ids;if(!("1"===n.properties[e].dataset.object)){var r=n.keyframesList[e].datas,i=r.item,a=r.properties;i.set.apply(i,[i.getIterationTime()].concat(a,[t])),this.update()}},t.restoreKeyframes=function(){this.scene.setTime(this.scene.getTime())},t.edit=function(e,t){var n=b(e,function(e){return k(e,"value")});if(n){var r=this.ids.values.map(function(e){return e.element}).indexOf(n);-1!==r&&this.editKeyframe(r,t)}},t.initEditor=function(){var n=this,e=this.ids.valuesArea.element;new s(e).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var t=e.inputEvent.target;n.edit(t,t.value)}).keyup("esc",function(e){e.inputEvent.target.blur()}),e.addEventListener("focusout",function(e){n.restoreKeyframes()})},e}(e)});
//# sourceMappingURL=timeline.min.js.map
