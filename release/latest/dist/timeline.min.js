/*
Copyright (c) 2019 Daybrush
name: @scenejs/timeline
license: MIT
author: Daybrush
repository: git+https://github.com/daybrush/scenejs-timeline.git
version: 0.0.8
*/
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("@daybrush/utils"),require("@daybrush/drag"),require("@egjs/axes"),require("keycon"),require("data-dom"),require("@egjs/component")):"function"==typeof define&&define.amd?define(["@daybrush/utils","@daybrush/drag","@egjs/axes","keycon","data-dom","@egjs/component"],n):(e=e||self).Timeline=n(e.utils,e.utils,e.eg.Axes,e.KeyController,e.DataDOM,e.Component)}(this,function(y,r,o,s,l,e){"use strict";var a=function(e,n){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var t in n)n.hasOwnProperty(t)&&(e[t]=n[t])})(e,n)};var c=function(){return(c=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var i in n=arguments[t])Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i]);return e}).apply(this,arguments)},p="scenejs_editor_",d=("\n.item_info {\n    position: fixed;\n    right: 0;\n    top: 0;\n    width: 200px;\n    background: #000;\n}\n.options_area {\n\n}\n.option_area {\n    position: relative;\n    border-bottom: 1px solid #777;\n    box-sizing: border-box;\n    white-space: nowrap;\n    background: rgba(90, 90, 90, 0.7);\n    font-size: 13px;\n    font-weight: bold;\n    color: #eee;\n    display: flex;\n}\n.option_name, .option_value {\n    width: 50%;\n    height: 30px;\n    line-height: 20px;\n    box-sizing: border-box;\n    padding: 5px;\n}\n.option_name {\n    border-right: 1px solid #999;\n}\n.option_value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n}\n".replace(/\.([^{,\s\d.]+)/g,"."+p+"$1"),'\n.timeline * {\n    box-sizing: border-box;\n}\n.timeline {\n  position: fixed;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  width: 100%;\n  font-size: 0;\n  background: #000;\n  display: flex;\n  flex-direction: column;\n}\n.header_area, .scroll_area {\n   width: 100%;\n   position: relative;\n  display: flex;\n  -webkit-align-items: flex-start;\n  align-items: flex-start;\n}\n.header_area {\n  position: relative;\n  z-index: 10;\n  top: 0;\n  height: 30px;\n  min-height: 30px;\n}\n.header_area .keyframes {\n  padding: 0px;\n}\n.header_area .properties_area,\n.header_area .keyframes_area,\n.header_area .values_area,\n.header_area .keyframes_scroll_area {\n    height: 100%;\n}\n.header_area .property, .header_area .value, .header_area .keyframes {\n  height: 100%;\n}\n.header_area .property {\n    line-height: 30px;\n}\n.value .add {\n    text-align: center;\n    color: #fff;\n    line-height: 30px;\n    font-weight: bold;\n    font-size: 20px;\n    cursor: pointer;\n}\n.header_area .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.header_area .keyframe_cursor {\n    position: absolute;\n    border-top: 10px solid #4af;\n    border-left: 6px solid transparent;\n    border-right: 6px solid transparent;\n    width: 0;\n    height: 0;\n    bottom: 0;\n    top: auto;\n    background: none;\n    cursor: pointer;\n}\n.control_area .keyframes {\n    padding-left: 10px;\n}\n.play_control_area {\n    position: absolute;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n}\n.play_control_area .control {\n    position: relative;\n    display: inline-block;\n    vertical-align: middle;\n    color: white;\n    margin: 0px 15px;\n}\n.play {\n    border-left: 14px solid white;\n    border-top: 8px solid transparent;\n    border-bottom: 8px solid transparent;\n}\n.pause {\n    border-left: 4px solid #fff;\n    border-right: 4px solid #fff;\n    width: 14px;\n    height: 16px;\n}\n.prev {\n    border-right: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.prev:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    right: 100%;\n    transform: translate(0, -50%);\n    background: white;\n}\n.next {\n    border-left: 10px solid white;\n    border-top: 6px solid transparent;\n    border-bottom: 6px solid transparent;\n}\n.next:before {\n    position: absolute;\n    content: "";\n    width: 3px;\n    height: 10px;\n    top: 0;\n    transform: translate(0, -50%);\n    background: white;\n}\n.keytime {\n  position: relative;\n  display: inline-block;\n  height: 100%;\n  font-size: 13px;\n  font-weight: bold;\n  color: #777;\n}\n.keytime:last-child {\n  max-width: 0px;\n}\n.keytime span {\n  position: absolute;\n  line-height: 1;\n  bottom: 12px;\n  display: inline-block;\n  transform: translate(-50%);\n  color: #eee;\n}\n.keytime .graduation {\n  position: absolute;\n  bottom: 0;\n  width: 1px;\n  height: 10px;\n  background: #777;\n  transform: translate(-50%);\n}\n.keytime .graduation.half {\n  left: 50%;\n  height: 7px;\n}\n.keytime .graduation.quarter {\n  left: 25%;\n  height: 5px;\n}\n.keytime .graduation.quarter3 {\n  left: 75%;\n  height: 5px;\n}\n.scroll_area {\n  position: relative;\n  width: 100%;\n  height: calc(100% - 60px);\n  overflow: auto;\n}\n.properties_area, .keyframes_area, .values_area {\n  display: inline-block;\n  position: relative;\n  font-size: 16px;\n  overflow: auto;\n}\n\n.properties_area::-webkit-scrollbar, .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.properties_area {\n  width: 30%;\n  max-width: 200px;\n  box-sizing: border-box;\n}\n.values_area {\n    width: 50px;\n    min-width: 50px;\n    display: inline-block;\n    border-right: 1px solid #999;\n    box-sizing: border-box;\n}\n.value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: transparent;\n    color: #4af;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n    text-align: center;\n}\n.value {\n\n}\n.alt .value input {\n    cursor: ew-resize;\n}\n.value[data-object="1"] input {\n    display: none;\n}\n.properties_scroll_area {\n  display: inline-block;\n  min-width: 100%;\n}\n.keyframes_area {\n  flex: 1;\n}\n.keyframes_scroll_area {\n  position: relative;\n  min-width: 300px;\n}\n.keyframes, .property, .value {\n  position: relative;\n  height: 30px;\n  line-height: 30px;\n  border-bottom: 1px solid #777;\n  box-sizing: border-box;\n  white-space: nowrap;\n  background: rgba(90, 90, 90, 0.7);\n  z-index: 1;\n}\n\n.property {\n  padding-left: 10px;\n  box-sizing: border-box;\n  font-size: 13px;\n  font-weight: bold;\n  color: #eee;\n}\n.property .remove {\n    position: absolute;\n    display: inline-block;\n    cursor: pointer;\n    width: 18px;\n    height: 18px;\n    top: 0;\n    bottom: 0;\n    right: 10px;\n    margin: auto;\n    border-radius: 50%;\n    border: 2px solid #fff;\n    vertical-align: middle;\n    display: none;\n    margin-left: 10px;\n    box-sizing: border-box;\n}\n.property .remove:before, .property .remove:after {\n    position: absolute;\n    content: "";\n    width: 8px;\n    height: 2px;\n    border-radius: 1px;\n    background: #fff;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    margin: auto;\n}\n.property .remove:before {\n    transform: rotate(45deg);\n}\n.property .remove:after {\n    transform: rotate(-45deg);\n}\n.property:hover .remove {\n    display: inline-block;\n}\n\n[data-item="1"], [data-item="1"] .add {\n    height: 30px;\n    line-height: 30px;\n}\n.time_area {\n    font-size: 13px;\n    color: #4af;\n    line-height: 30px;\n    font-weight: bold;\n    height: 100%;\n    line-height: 30px;\n    border: 0;\n    background: transparent;\n    outline: 0;\n}\n.time_area:after {\n    content: "s";\n}\n.property .arrow {\n    position: relative;\n    display: inline-block;\n    margin-right: 5px;\n    width: 0;\n    vertical-align: middle;\n    cursor: pointer;\n    border-top: 6px solid #eee;\n    border-left: 4px solid transparent;\n    border-right: 4px solid transparent;\n}\n.property[data-fold="1"] .arrow {\n    border-top: 4px solid transparent;\n    border-bottom: 4px solid transparent;\n    border-right: 0;\n    border-left: 6px solid #eee;\n    margin-left: 2px;\n}\n.property[data-object="0"] .arrow {\n    display: none;\n}\n.property.fold, .keyframes.fold, .value.fold {\n    display: none;\n}\n.property.select, .value.select, .keyframes.select {\n    background: rgba(120, 120, 120, 0.7);\n}\n.keyframes {\n\n}\n.keyframe_delay {\n  position: absolute;\n  height: 100%;\n  top: 0;\n  left: 0;\n  background: #4af;\n  opacity: 0.2;\n  z-index: 0;\n}\n.keyframe_line {\n  position: absolute;\n  height: 8px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  background: #666;\n  z-index: 0;\n}\n.keyframe {\n  position: absolute;\n  font-size: 0px;\n  width: 12px;\n  height: 12px;\n  top: 0px;\n  bottom: 0px;\n  margin: auto;\n  background: #fff;\n  border: 2px solid #383838;\n  border-radius: 2px;\n  box-sizing: border-box;\n  transform: translate(-50%) rotate(45deg);\n  z-index: 1;\n  cursor: pointer;\n}\n.keyframe[data-no="1"] {\n    opacity: 0.2;\n}\n.select .keyframe {\n    border-color: #555;\n}\n.keyframe.select {\n    background: #4af;\n}\n.keyframes_container, .line_area {\n  position: relative;\n  width: calc(100% - 30px);\n  left: 15px;\n  height: 100%;\n}\n.line_area {\n  position: absolute;\n  top: 0;\n  z-index: 0;\n}\n.keyframe_cursor {\n  position: absolute;\n  top: 0;\n  z-index: 1;\n  background: #4af;\n  width: 1px;\n  height: 100%;\n  left: 15px;\n  transform: translate(-50%);\n}\n.division_line {\n  position: absolute;\n  background: #333;\n  width: 1px;\n  height: 100%;\n  transform: translate(-50%);\n}\n'.replace(/\.([^{,\s\d.]+)/g,"."+p+"$1")),_="direction",w="iterationCount",A="delay",E="playSpeed",T="alternate",z="reverse",I="alternate-reverse";function f(e,n,t){var r=(""+e).length,i=[];t&&i.push(e);for(var a=r;a<n;++a)i.push(0);return t||i.push(e),i.join("")}function u(e,n){for(var t in n)e.style[t]=n[t]}function m(n,e){return e.findIndex(function(e){return e.dataset.key===n})}function h(e){var n=e.selector,t=e.dataset,r=e.attr,i=e.style,a=e.html,o=n.match(/\.([^.#\s])+/g)||[],s=(n.match(/^[^.#\s]+/g)||[])[0]||"div",l=(n.match(/#[^.#\s]+/g)||[])[0]||"",c=document.createElement(s);if(l&&(c.id=l.replace(/^#/g,"")),c.className=o.map(function(e){return p+e.replace(/^\./g,"")}).join(" "),t)for(var d in t)c.setAttribute("data-"+d,t[d]);if(r)for(var d in r)c.setAttribute(d,r[d]);return i&&u(c,i),a&&(c.innerHTML=a),c}function v(e,n){var t=n.dataset,r=n.attr,i=n.style,a=n.html,o=n.element;if(t)for(var s in t)o.setAttribute("data-"+s,t[s]);if(r)for(var s in r)o.setAttribute(s,r[s]);i&&u(o,i),e.html!==n.html&&(o.innerHTML=a)}function g(n){return"object"==typeof n?Array.isArray(n)?"["+n.join(", ")+"]":"{"+function(e){var n=[];for(var t in e)n.push(t);return n}(n).map(function(e){return e+": "+g(n[e])}).join(", ")+"}":n}function b(e,n){for(var t=e;t&&t!==document.body;){if(n(t))return t;t=t.parentNode}return null}function k(e,n){return y.hasClass(e,p+n)}function x(e,n){return y.addClass(e,p+n)}function P(e,n){return y.removeClass(e,p+n)}function L(e){return!!e.constructor.prototype.getItem}function j(e,n){for(var t=e.length,r=0;r<t;++r){var i=e[r].getBoundingClientRect(),a=i.top,o=a+i.height;if(a<=n&&n<o)return r}return-1}var C=0,D=-1,S=-1;function M(n,e,t,r){return{ref:function(e){n.keyframesAreas[0]=e},selector:".keyframes_area",children:{style:{minWidth:50*r+"px",width:Math.min(t?r/t:1,2)*e*100+"%"},dataset:{width:Math.min(t?r/t:1,2)},ref:function(e){n.keyframesScrollAreas[0]=e},selector:".keyframes_scroll_area",children:{ref:function(e){n.cursors=[]},selector:".keyframes",children:[{ref:function(e){n.keytimesContainer=e},selector:".keyframes_container",children:function(e){for(var n=[],t=0;t<=e;++t)n.push({key:t,dataset:{time:t},selector:".keytime",style:{width:100/e+"%"},children:[{selector:"span",html:""+t},{selector:".graduation.start"},{selector:".graduation.quarter"},{selector:".graduation.half"},{selector:".graduation.quarter3"}]});return n}(r)},{selector:".keyframe_cursor",ref:function(e){n.cursors[0]=e}}]}}}}function K(n,e,t,r,i){var a=Math.min(r?i/r:1,2);return{ref:function(e){n.keyframesAreas[1]=e},selector:".keyframes_area",children:{style:{minWidth:50*i+"px",width:a*t*100+"%"},dataset:{width:a},ref:function(e){n.keyframesScrollAreas[1]=e},selector:".keyframes_scroll_area",children:function(n,e,t){return e.concat([{key:"cursor",selector:".keyframe_cursor",ref:function(e){n.cursors[1]=e}},{key:"lineArea",ref:function(e){n.lineArea=e},selector:".line_area",children:function(e){for(var n=[],t=0;t<=e;++t)n.push({key:t,selector:".division_line",style:{left:100/e*t+"%"}});return n}(t)}])}(n,e,i)}}}function O(e,p){var f=[],u=e.item.getDuration(),m=e.frames,h=[];return m.map(function(e,n){var t=e[0],r=e[1],i=e[2],a=g(i);if(m[n+1]){var o=m[n+1],s=o[0],l=o[1],c=o[2],d=g(c);(0===r&&0===l||r===u&&l===u)&&h.push(function(e,n,t){return{selector:".keyframe_delay",key:"delay"+e+","+n,datas:{time:-1},style:{left:e/t*100+"%",width:(n-e)/t*100+"%"}}}(t,s,p)),y.isUndefined(i)||y.isUndefined(c)||a===d||f.push({selector:".keyframe_line",key:t+","+s,datas:{time:t+","+s,from:t,to:s},style:{left:t/p*100+"%",width:(s-t)/p*100+"%"}})}return{key:t,selector:".keyframe",dataset:{time:t},datas:{time:t,iterationTime:r,value:a},style:{left:t/p*100+"%"},html:t+" "+a}}).concat(h,f)}function q(n,e,t,r,i){var a=function(t,e,n){var r=[];for(var i in e){var a=e[i],o=O(a,n);r.push({ref:function(e,n){t.keyframesList[n]=e,t.keyframesContainers[n]=e.children},selector:".keyframes",key:i,dataset:{item:a.isItem?"1":"0",key:i},datas:a,children:{selector:".keyframes_container",children:o}})}return r}(n,e,i);return{ref:function(e){n.scrollArea=e,n.keyframesList=[],n.keyframesContainers=[]},selector:".scroll_area",children:[{ref:function(e){n.propertiesAreas[1]=e,n.properties=[]},selector:".properties_area",children:[{selector:".properties_scroll_area",children:function(t,e){var n=[];for(var r in e){var i=e[r],a=r.split("///"),o=a.length,s=a[o-1];n.push({ref:function(e,n){t.properties[n]=e},key:r,selector:".property",dataset:{key:r,object:i.isParent?"1":"0",item:i.isItem?"1":"0"},datas:i,style:{paddingLeft:10+20*(o-1)+"px"},children:[{selector:".arrow"},{selector:"span",html:s},{selector:".remove"}]})}return n}(n,e)}]},{ref:function(e){n.valuesArea=e,n.values=[]},selector:".values_area",children:function(t,e){var n=[];for(var r in e){var i=e[r],a=i.frames;n.push({ref:function(e,n){t.values[n]=e},key:r,selector:".value",dataset:{key:r,item:i.isItem?"1":"0",object:i.isParent?"1":"0"},datas:i,children:i.isParent?{key:"add",selector:".add",html:"+"}:{key:"input",selector:"input",attr:{value:a[0]?a[0][1]:""}}})}return n}(n,e)},K(n,a,t,r,i)]}}var n=1e6;function i(e){return Math.round(e*n)/n}function B(e,n,t){var r=e[e.length-1];(!r||r[0]!==n||r[1]!==t)&&e.push([i(n),i(t)])}function F(c,e,d,p){p.update();var f=function(e,n){if(!e.length)return[];var k=e.map(function(e){return[e,e]}),x=[];return 0!==k[0][0]&&n[n.length-1][A]&&k.unshift([0,0]),n.forEach(function(e){for(var n,t,r=e[w],i=e[A],a=e[E],o=e[_],s=Math.ceil(r),l=k[k.length-1][0],c=k.length,d=l*r,p=0;p<s;++p)for(var f=o===z||o===T&&p%2||o===I&&!(p%2),u=0;u<c;++u){var m=k[f?c-u-1:u],h=m[1],y=l*p+(f?l-m[0]:m[0]),v=k[f?c-u:u-1];if(d<y){if(0!==u){var g=l*p+(f?l-v[0]:v[0]),b=(v[1]*(t=y-d)+h*(n=d-g))/(n+t);B(x,(i+l*r)/a,b)}break}if(y===d&&x[x.length-1][0]===d+i)break;B(x,(i+y)/a,h)}i&&x.unshift([0,x[0][1]]),k=x,x=[]}),k}(p.times,e.map(function(e){return e.state}));!function e(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];var a=[],r=y.isObject(n),o=0===i.length;f.forEach(function(e){var n=e[0],t=e[1],r=p.get.apply(p,[t].concat(i));y.isUndefined(r)&&i.length||a.push([n,t,r])});var s=d.concat(i).join("///");if(c[s]={key:s,parentItem:null,isParent:r,isItem:o,item:p,names:d,properties:i,frames:a},r)for(var l in n)e.apply(void 0,[n[l]].concat(i,[l]))}(p.names)}function N(e){var s={};return function n(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t.length,i=t[r-1],a=t.slice(1).map(function(e){return e.getId()});if(L(i)){if(a.length){var o=a.join("///");s[o]={key:o,isItem:!0,isParent:!0,parentItem:t[r-2],item:i,names:[],properties:[],frames:[]}}i.forEach(function(e){n.apply(void 0,t.concat([e]))})}else F(s,t,a,i)}(e),s}var X=!1;return function(i){function e(e,n,t){void 0===t&&(t={});var r=i.call(this)||this;return r.maxTime=0,r.selectedProperty="",r.selectedTime=-1,r.ids={},r.options=c({keyboard:!0},t),e.finish(),r.scene=e,r.initStructure(e,n),r.initEditor(),r.initScroll(),r.initWheelZoom(),r.initDragKeyframes(),r.initClickProperty(),r.initController(),r.initDragValues(),r.initKeyController(),r.setTime(0),r}!function(e,n){function t(){this.constructor=e}a(e,n),e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}(e,i);var n=e.prototype;return n.getElement=function(){return this.structure.element},n.prev=function(){this.setTime(this.scene.getTime()-.05)},n.next=function(){this.setTime(this.scene.getTime()+.05)},n.finish=function(){this.scene.finish()},n.togglePlay=function(){var e=this.scene;"running"===e.getPlayState()?e.pause():e.play()},n.setTime=function(e){var n=this.scene,t=n.getDirection();"normal"===t||"alternate"===t?n.setTime(e):n.setTime(n.getDuration()-e)},n.update=function(){var e=this.scene;this.timelineInfo=N(e);var n=Math.ceil(e.getDuration()),t=n,r=this.axes.get(["zoom"]).zoom,i=this.maxTime;this.maxTime=t;var a=this.ids,o=a.keyframesAreas[0];r*=5<i?n/i:1,this.axes.axm.set({zoom:r}),this.datadom.update(o,M(a,r,n,t));var s=q(a,this.timelineInfo,this.axes.get(["zoom"]).zoom,n,this.maxTime);this.datadom.update(a.scrollArea,s),this.setTime(e.getTime())},n.initController=function(){var i=this,a=this.ids,e=this.ids.playBtn.element,n=this.scene;this.ids.addItem.element.addEventListener("click",function(e){var n=prompt("Add Item");n&&(i.scene.newItem(n),i.update())}),e.addEventListener("click",function(e){i.togglePlay(),e.preventDefault()}),a.unselectedArea.element.addEventListener("click",function(e){i.select("",-1)}),a.prevBtn.element.addEventListener("click",function(e){i.prev(),e.preventDefault()}),a.nextBtn.element.addEventListener("click",function(e){i.next(),e.preventDefault()}),n.on("play",function(){x(e,"pause"),P(e,"play")}),n.on("paused",function(){x(e,"play"),P(e,"pause")}),this.options.keyboard&&new s(a.timeArea.element).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=a.timeArea.element.value,t=/(\d+):(\d+):(\d+)/g.exec(n);if(t){var r=60*parseFloat(t[1])+parseFloat(t[2])+parseFloat("0."+t[3]);i.setTime(r)}})},n.initKeyController=function(){var n=this,e=this.ids;window.addEventListener("blur",function(){P(e.timeline.element,"alt")}),this.keycon=(new s).keydown("alt",function(){x(e.timeline.element,"alt")}).keyup("alt",function(){P(e.timeline.element,"alt")}),this.options.keyboard&&this.keycon.keydown("space",function(e){e.inputEvent.preventDefault()}).keydown("left",function(e){n.prev()}).keydown("right",function(e){n.next()}).keyup("backspace",function(){n.removeKeyframe(n.selectedProperty)}).keyup("esc",function(){n.finish()}).keyup("space",function(){n.togglePlay()})},n.initStructure=function(e,n){this.timelineInfo=N(e);var t,r=Math.ceil(e.getDuration()),i=Math.ceil(r),a=i,o=this.ids;this.maxTime=a,X||(t={selector:"style.style",html:d},X=!0);var s={selector:".timeline",ref:function(e){o.timeline=e},children:[t,function(n){return{selector:".header_area.control_area",children:[{selector:".properties_area",ref:function(e){n.unselectedArea=e},children:{selector:".property"}},{selector:".values_area",children:{selector:".value"}},{selector:".keyframes_area",children:{selector:".keyframes",children:[{selector:"input.time_area",ref:function(e){n.timeArea=e},html:"???"},{selector:".play_control_area",children:[{ref:function(e){n.prevBtn=e},selector:".control.prev"},{ref:function(e){n.playBtn=e},selector:".control.play"},{ref:function(e){n.nextBtn=e},selector:".control.next"}]}]}}]}}(o),function(n,e,t,r){return{selector:".header_area",ref:function(e){n.keyframesScrollAreas=[],n.keyframesAreas=[],n.propertiesAreas=[]},children:[{ref:function(e){n.propertiesAreas[0]=e},selector:".properties_area",children:[{selector:".property",html:"Name"}]},{selector:".values_area",children:{selector:".value",children:{key:"add",selector:".add",html:"+",ref:function(e){n.addItem=e}}}},M(n,e,t,r)]}}(o,1,i,a),q(o,this.timelineInfo,1,i,a)]};this.datadom=new l(h,v),this.structure=this.datadom.render(s,n)},n.initScroll=function(){var e=this.ids.keyframesAreas,n=!1,t=e[0].element,r=e[1].element;t.addEventListener("scroll",function(){n?n=!1:(n=!0,r.scrollLeft=t.scrollLeft)}),r.addEventListener("scroll",function(){n?n=!1:(n=!0,t.scrollLeft=r.scrollLeft)})},n.initWheelZoom=function(){var t=this,r=this.ids,e=r.keyframesScrollAreas,n=e[0].element,i=e[1].element,a=new o({zoom:{range:[1,1/0]}},{},{zoom:1});a.connect("zoom",new o.PinchInput(i,{scale:.1,hammerManagerOptions:{touchAction:"auto"}})),a.on("hold",function(e){e.inputEvent&&e.inputEvent.preventDefault()}),a.on("change",function(e){var n=r.keyframesScrollAreas[0].dataset.width,t=e.pos.zoom*n*100;r.keyframesScrollAreas.forEach(function(e){e.element.style.width=t+"%"}),e.inputEvent&&e.inputEvent.preventDefault()}),this.axes=a,n.addEventListener("wheel",function(e){var n=e.deltaY;a.setBy({zoom:n/5e3}),!e.deltaX&&e.preventDefault()}),y.addEvent(i,"wheel",function(e){if(t.keycon.altKey){e.preventDefault();var n=e.deltaY;a.setBy({zoom:n/5e3})}})},n.select=function(e,n){var t=this.selectedProperty,r=this.selectedTime,i=this.ids,a=i.values,o=i.properties,s=i.keyframesList;if(this.selectedProperty=e,this.scene.pause(),t){var l=m(t,o);if(P(o[l].element,"select"),P(a[l].element,"select"),P(s[l].element,"select"),0<=r)i.keyframesContainers[l].children.forEach(function(e){e.datas.time===r&&P(e.element,"select")}),this.selectedTime=-1}var c=this.scene;if(e){document.activeElement&&document.activeElement.blur();var d=m(e,o);if(x(o[d].element,"select"),x(a[d].element,"select"),x(s[d].element,"select"),c=i.keyframesList[d].datas.item,0<=n)i.keyframesContainers[d].children.forEach(function(e){e.datas.time===n&&x(e.element,"select")}),this.selectedTime=n}this.trigger("select",{selectedItem:c,selectedProperty:this.selectedProperty,selectedTime:this.selectedTime,prevSelectedProperty:t,prevSelectedTime:r})},n.initClickProperty=function(){var s=this,l=this.ids;l.propertiesAreas[1].element.addEventListener("click",function(e){var n=l.properties.map(function(e){return e.element}),t=(n.length,b(e.target,function(e){return k(e,"arrow")})),r=b(e.target,function(e){return k(e,"remove")}),i=b(e.target,function(e){return k(e,"property")});if(i){var a=n.indexOf(i);if(-1!==a){var o=l.properties[a];r?s.remove(o.datas):(s.select(o.dataset.key),t&&s.fold(a))}}})},n.setInputs=function(e){var n=this.ids.valuesArea.element;for(var t in e)n.querySelector('[data-key="'+t+'"] input').value=e[t]},n.moveCursor=function(e){var n=this.ids.cursors,t=this.maxTime,r="calc("+100*e/t+"% + "+(15-30*e/t)+"px)";n.forEach(function(e){e.element.style.left=r})},n.initDragKeyframes=function(){var s=this,l=this.ids,i=l.scrollArea,a=l.timeArea,e=l.cursors,o=l.keyframesAreas,c=l.keyframesScrollAreas;this.scene.on("animate",function(e){console.log(e);var n=e.time;s.moveCursor(n),s.setInputs(function e(n,t){for(var r in void 0===t&&(t={}),n){var i=n[r];if(y.isObject(i)){var a=e(i.constructor.prototype.toCSS?i.get():i);for(var o in a)t[r+"///"+o]=a[o]}else t[r]=i}return t}(e.frames));var t=f(Math.floor(n/60),2),r=f(Math.floor(n%60),2),i=f(Math.floor(n%1*100),3,!0);a.element.value=t+":"+r+":"+i});var d=function(e){var n=c[1].element.getBoundingClientRect(),t=n.width-30,r=n.left+15,i=Math.min(t,Math.max(e-r,0))/t,a=s.maxTime*i;return a=Math.round(20*a)/20},p=function(e,n,t){var r=j(l.keyframesList.map(function(e){return e.element}),t);-1!==r&&s.addKeyframe(r,d(n))};r.drag(e[0].element,{dragstart:function(e){e.inputEvent.stopPropagation()},drag:function(e){!function(e){s.setTime(d(e))}(e.clientX)},container:window}),c.forEach(function(e){var n=e.element;r.drag(n,{container:window,drag:function(e){var n=e.deltaX,t=e.deltaY,r=e.inputEvent;o[1].element.scrollLeft-=n,i.element.scrollTop-=t,r.preventDefault()},dragend:function(e){var n=e.isDrag,t=e.clientX,r=e.clientY,i=e.inputEvent;!n&&function(e,n,t){var r=b(e.target,function(e){return k(e,"keyframe")}),i=r?parseFloat(r.getAttribute("data-time")):d(n);s.setTime(i);var a=l.keyframesList,o=j(a.map(function(e){return e.element}),t);-1<o&&s.select(a[o].dataset.key,i),e.preventDefault()}(i,t,r),function(e,n,t,r,i){var a=y.now();e||(D===t&&S===r&&a-C<=500&&i(n,t,r),D=t,S=r,C=a)}(n,i,t,r,p)}})})},n.initDragValues=function(){var t,s=this,l=this.ids,e=l.valuesArea.element,c=null;y.addEvent(e,"click",function(e){var n=b(c,function(e){return k(e,"add")});if(n){var t=m(n.parentElement.getAttribute("data-key"),l.values);if(!(t<0)){var r=prompt("add property");if(r){var i=l.properties[t].datas,a=i.properties.slice(),o=i.item;o.set.apply(o,[o.getIterationTime()].concat(a,[r,0])),s.update()}}}}),r.drag(e,{container:window,dragstart:function(e){if(c=e.inputEvent.target,t=c.value,!s.keycon.altKey||!b(c,function(e){return"INPUT"===e.nodeName}))return!1},drag:function(n){var e=t.replace(/-?\d+/g,function(e){return""+(parseFloat(e)+Math.round(n.distX/2))});c.value=e},dragend:function(e){s.edit(c,c.value)}})},n.addKeyframe=function(e,n){var t=this.ids.keyframesList,r=t[e].dataset.key,i=t[e].datas;i.item,i.properties;this.select(r,n);var a=this.ids.values[e].children.element.value;this.editKeyframe(e,a)},n.fold=function(e){var n,t=this.ids,r=t.properties,i=t.values,a=t.keyframesList,o=r[e],s=r.length;for(n=e;n<s&&0===r[n].datas.key.indexOf(o.datas.key);++n);var l=r.slice(e+1,n),c=i.slice(e+1,n),d=a.slice(e+1,n),p=o.element,f="1"===p.getAttribute("data-fold");p.setAttribute("data-fold",f?"0":"1");var u=f?P:x;l.forEach(function(e,n){u(e.element,"fold"),u(c[n].element,"fold"),u(d[n].element,"fold")})},n.remove=function(e){var n=e.key,t=e.isItem,r=e.parentItem,i=e.item,a=e.properties;if(t){var o=null;r.forEach(function(e,n){e!==i||(o=n)}),null!=o&&r.removeItem(o)}else{i.times.forEach(function(e){var n;(n=i).remove.apply(n,[e].concat(a))})}this.selectedProperty===n&&(this.selectedProperty="",this.selectedTime=-1),this.update()},n.removeKeyframe=function(e){var n=this.timelineInfo[e];if(e&&n&&!L(n.item)){var t=n.properties,r=n.item;r.remove.apply(r,[r.getIterationTime()].concat(t)),this.update()}},n.editKeyframe=function(e,n){var t=this.ids;if(!("1"===t.properties[e].dataset.object)){var r=t.keyframesList[e].datas,i=r.item,a=r.properties;i.set.apply(i,[i.getIterationTime()].concat(a,[n])),this.update()}},n.restoreKeyframes=function(){this.setTime(this.scene.getTime())},n.edit=function(e,n){var t=b(e,function(e){return k(e,"value")});if(t){var r=this.ids.values.map(function(e){return e.element}).indexOf(t);-1!==r&&this.editKeyframe(r,n)}},n.initEditor=function(){var t=this,e=this.ids.valuesArea.element;new s(e).keydown(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup(function(e){!e.isToggle&&e.inputEvent.stopPropagation()}).keyup("enter",function(e){var n=e.inputEvent.target;t.edit(n,n.value)}).keyup("esc",function(e){e.inputEvent.target.blur()}),e.addEventListener("focusout",function(e){t.restoreKeyframes()})},e}(e)});
//# sourceMappingURL=timeline.min.js.map
