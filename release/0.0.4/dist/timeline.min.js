/*
Copyright (c) 2019 
name: @scenejs/timeline
license: ISC
author: 
repository: git+https://github.com/daybrush/scenejs-timeline.git
version: 0.0.4
*/
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("@daybrush/utils"),require("@daybrush/drag"),require("@egjs/axes")):"function"==typeof define&&define.amd?define(["@daybrush/utils","@daybrush/drag","@egjs/axes"],n):(e=e||self).Timeline=n(e.utils,e.utils,e.eg.Axes)}(this,function(y,r,i){"use strict";var u="scenejs_timeline_",v='\n.timeline {\n  position: relative;\n  font-size: 0;\n  background: #000;\n  display: flex;\n  flex-direction: column;\n}\n.header_area, .scroll_area {\n   width: 100%;\n   position: relative;\n  display: flex;\n  -webkit-align-items: flex-start;\n  align-items: flex-start;\n}\n.header_area {\n  position: relative;\n  z-index: 10;\n  top: 0;\n  height: 30px;\n  min-height: 30px;\n}\n.header_area .keyframes {\n  padding: 0px;\n}\n.header_area .properties_area,\n.header_area .keyframes_area,\n.header_area .values_area,\n.header_area .keyframes_scroll_area {\n    height: 100%;\n}\n.header_area .property, .header_area .value, .header_area .keyframes {\n  height: 100%;\n}\n.header_area .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.header_area .keyframe_cursor {\n    position: absolute;\n    border-top: 10px solid #f55;\n    border-left: 5px solid transparent;\n    border-right: 5px solid transparent;\n    width: 0;\n    height: 0;\n    bottom: 0;\n    top: auto;\n    background: none;\n    cursor: pointer;\n}\n.keytime {\n  position: relative;\n  display: inline-block;\n  height: 100%;\n  font-size: 13px;\n  font-weight: bold;\n  color: #777;\n}\n.keytime:last-child {\n  max-width: 0px;\n}\n.keytime span {\n  display: inline-block;\n  transform: translate(-50%);\n  color: #eee;\n}\n.keytime .graduation {\n  position: absolute;\n  bottom: 0;\n  width: 1px;\n  height: 10px;\n  background: #777;\n  transform: translate(-50%);\n}\n.keytime .graduation.half {\n  left: 50%;\n  height: 7px;\n}\n.keytime .graduation.quarter {\n  left: 25%;\n  height: 5px;\n}\n.keytime .graduation.quarter3 {\n  left: 75%;\n  height: 5px;\n}\n.scroll_area {\n  position: relative;\n  width: 100%;\n  height: calc(100% - 30px);\n  overflow: auto;\n}\n.properties_area, .keyframes_area, .values_area {\n  display: inline-block;\n  position: relative;\n  font-size: 16px;\n  overflow: auto;\n}\n\n.properties_area::-webkit-scrollbar, .keyframes_area::-webkit-scrollbar {\n    display: none; // Safari and Chrome\n}\n.properties_area {\n  width: 30%;\n  max-width: 200px;\n  box-sizing: border-box;\n}\n.values_area {\n    width: 50px;\n    min-width: 50px;\n    display: inline-block;\n    border-right: 1px solid #999;\n    box-sizing: border-box;\n}\n.value input {\n    appearance: none;\n    -webkit-appearance: none;\n    outline: none;\n    position: relative;\n    display: block;\n    width: 100%;\n    height: 100%;\n    background: none;\n    color: #ff5;\n    font-weight: bold;\n    background: none;\n    border: 0;\n    box-sizing: border-box;\n    text-align: center;\n}\n.value[data-object="1"] input {\n    display: none;\n}\n.properties_scroll_area {\n  display: inline-block;\n  min-width: 100%;\n}\n.keyframes_area {\n  flex: 1;\n}\n.keyframes_scroll_area {\n  position: relative;\n  min-width: 300px;\n}\n.keyframes, .property, .value {\n  position: relative;\n  height: 25px;\n  border-bottom: 1px solid #777;\n  box-sizing: border-box;\n  white-space: nowrap;\n  background: rgba(73, 73, 73, 0.7);\n  z-index: 1;\n}\n.property:nth-child(2n), .keyframes:nth-child(2n), .value:nth-child(2n) {\n  background: rgba(90, 90, 90, 0.7);\n}\n.property {\n  line-height: 25px;\n  padding-left: 10px;\n  box-sizing: border-box;\n  font-size: 13px;\n  font-weight: bold;\n  color: #eee;\n}\n.property.time_area {\n    color: #ff5;\n    line-height: 30px;\n}\n.property .arrow {\n    position: relative;\n    display: inline-block;\n    margin-right: 5px;\n    width: 0;\n    vertical-align: middle;\n}\n.property .arrow {\n    border-top: 6px solid #eee;\n    border-left: 4px solid transparent;\n    border-right: 4px solid transparent;\n}\n.property[data-fold="1"] .arrow {\n    border-top: 4px solid transparent;\n    border-bottom: 4px solid transparent;\n    border-right: 0;\n    border-left: 6px solid #eee;\n    margin-left: 2px;\n}\n.property[data-object="0"] .arrow {\n    display: none;\n}\n.property.fold, .keyframes.fold, .value.fold {\n    display: none;\n}\n.keyframes {\n\n}\n.keyframe_line {\n  position: absolute;\n  height: 8px;\n  top: 0;\n  bottom: 0;\n  margin: auto;\n  background: #aaa;\n  z-index: 0;\n}\n.keyframe {\n  position: absolute;\n  font-size: 0px;\n  width: 12px;\n  height: 12px;\n  top: 0px;\n  bottom: 0px;\n  margin: auto;\n  background: #fff;\n  border: 2px solid #333;\n  border-radius: 2px;\n  box-sizing: border-box;\n  transform: translate(-50%) rotate(45deg);\n  z-index: 1;\n  cursor: pointer;\n}\n.keyframes_container, .line_area {\n  position: relative;\n  width: calc(100% - 30px);\n  left: 15px;\n  height: 100%;\n}\n.line_area {\n  position: absolute;\n  top: 0;\n  z-index: 0;\n}\n.keyframe_cursor {\n  position: absolute;\n  top: 0;\n  z-index: 1;\n  background: #f55;\n  width: 1px;\n  height: 100%;\n  left: 15px;\n  transform: translate(-50%);\n}\n.division_line {\n  position: absolute;\n  background: #333;\n  width: 1px;\n  height: 100%;\n  transform: translate(-50%);\n}\n'.replace(/\.([^{,\s\d.]+)/g,"."+u+"$1");function b(n){return"object"==typeof n?Array.isArray(n)?"["+n.join(", ")+"]":"{"+function(e){var n=[];for(var r in e)n.push(r);return n}(n).map(function(e){return e+": "+b(n[e])}).join(", ")+"}":n}function h(e,n){for(var r=e;r&&r!==document.body;){if(n(r))return r;r=r.parentNode}return null}function m(e,n){return y.hasClass(e,""+u+n)}function g(e,n){return y.addClass(e,""+u+n)}function x(e,n){return y.removeClass(e,""+u+n)}function k(e,n,r){void 0===r&&(r={});var t=e.selector,a=e.id,i=e.attr,o=e.dataset,s=e.children,l=e.style,d=e.html,c=function(e,n){var r=e.match(/\.([^.#\s])+/g)||[],t=(e.match(/^[^.#\s]+/g)||[])[0]||"div",a=(e.match(/#[^.#\s]+/g)||[])[0]||"",i=document.createElement(t);return a&&(i.id=a.replace(/^#/g,"")),i.className=r.map(function(e){return""+u+e.replace(/^\./g,"")}).join(" "),n&&n.appendChild(i),i}(t);if(a)if(-1<a.indexOf("[]")){var p=a.replace("[]","");r[p]||(r[p]=[]),r[p].push(c)}else r[a]=c;if(o)for(var f in o)c.setAttribute("data-"+f,o[f]);if(i)for(var f in i)c.setAttribute(f,i[f]);if(l)for(var f in l)c.style[f]=l[f];return d&&(c.innerHTML=d),s&&[].concat(s).filter(function(e){return e}).forEach(function(e){y.isString(e)?k({selector:e},c,r):k(e,c,r)}),n&&n.appendChild(c),r}var _=!1;return function(){function e(e,n){e.finish(),this.scene=e,this.initElement(e,n)}var n=e.prototype;return n.getElement=function(){return this.ids.timeline},n.initElement=function(e,n){var r,t=e.getDuration(),d=function(e){var l={};return e.forEach(function(n){var s=n.getDelay();n.times.forEach(function(o){var e=n.getFrame(o);!function n(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var t=e[e.length-1],a=e.slice(0,-1),i=a.join("///");i&&(l[i]||(l[i]=[]),l[i].push([s+o,t])),"object"==typeof t&&Object.keys(t).forEach(function(e){n.apply(void 0,a.concat([e,t[e]]))})}(n.getId(),e.get())})}),l}(e),a=Math.ceil(t),c=a,i=[],p=[],f=[],o=[],u=[];_||(r={selector:"style.style",html:v},_=!0);for(var s=0;s<=c;++s){var l=s;i.push({selector:".keytime",style:{width:100/c+"%"},children:[{selector:"span",html:l+"s"},".graduation.start",".graduation.quarter",".graduation.half",".graduation.quarter3"]}),o.push({selector:".division_line",style:{left:100/c*s+"%"}})}var h=function(e){var n=e.split("///"),r=n.length,o=d[e],t=n[r-1];p.push({id:"properties[]",selector:".property",dataset:{id:t,property:e,parent:n[r-2]||"",object:"0",item:n[0]},style:{paddingLeft:10+20*(r-1)+"px"},children:[".arrow",{selector:"span",html:t}]});var a=o[0]&&y.isObject(o[0][1]);f.push({id:"values[]",selector:".value",dataset:{property:e,object:a?"1":"0"},children:{id:"inputs[]",selector:"input",attr:{value:o[0]?o[0][1]:""}}});var i=n.slice(0,-1).join("///");p.forEach(function(e){var n=e.dataset;n.property===i&&(n.object="1")});var s=[],l=o.map(function(e,n){var r=e[0],t=b(e[1]);if(o[n+1]){var a=o[n+1],i=a[0];t===b(a[1])&&s.push({selector:".keyframe_line",style:{left:r/c*100+"%",width:(i-r)/c*100+"%"}})}return{selector:".keyframe",dataset:{time:r,value:t},style:{left:r/c*100+"%"},html:r+" "+t}});u.push({id:"keyframesList[]",selector:".keyframes",dataset:{property:e},children:{selector:".keyframes_container",children:l.concat(s)}})};for(var m in d)h(m);var g={selector:".timeline",id:"timeline",children:[r,{selector:".header_area",children:[{id:"propertiesAreas[]",selector:".properties_area",children:[{id:"timeArea",selector:".property.time_area",html:"0s"}]},{selector:".values_area",children:".value"},{id:"keyframesAreas[]",selector:".keyframes_area",children:{style:{minWidth:50*c+"px",width:100*(a?c/a:1)+"%"},id:"keyframesScrollAreas[]",selector:".keyframes_scroll_area",children:{selector:".keyframes",children:[{selector:".keyframes_container",children:i},{selector:".keyframe_cursor",id:"cursors[]"}]}}}]},{id:"scrollArea",selector:".scroll_area",children:[{id:"propertiesAreas[]",selector:".properties_area",children:[{selector:".properties_scroll_area",children:p}]},{id:"valuesArea",selector:".values_area",children:f},{id:"keyframesAreas[]",selector:".keyframes_area",children:{style:{minWidth:50*c+"px",width:100*(a?c/a:1)+"%"},id:"keyframesScrollAreas[]",selector:".keyframes_scroll_area",children:u.concat([{selector:".keyframe_cursor",id:"cursors[]"},{selector:".line_area",children:o}])}}]}]};this.ids=k(g,n),this.syncScroll(),this.wheelZoom(),this.drag(),this.fold()},n.syncScroll=function(){var e=this.ids.keyframesAreas,n=!1;e[0].addEventListener("scroll",function(){n?n=!1:(n=!0,e[1].scrollLeft=e[0].scrollLeft)}),e[1].addEventListener("scroll",function(){n?n=!1:(n=!0,e[0].scrollLeft=e[1].scrollLeft)})},n.wheelZoom=function(){var r=this.ids.keyframesScrollAreas,t=parseFloat(r[0].style.width),a=new i({zoom:{range:[100,1/0]}},{},{zoom:t});a.connect("zoom",new i.PinchInput(r[1],{scale:.7,hammerManagerOptions:{touchAction:"auto"}})),a.on("hold",function(e){console.log("hold"),e.inputEvent&&e.inputEvent.preventDefault()}),a.on("change",function(e){var n=e.pos.zoom;r.forEach(function(e){e.style.width=n+"%"}),e.inputEvent&&e.inputEvent.preventDefault()}),r[0].addEventListener("wheel",function(e){var n=e.deltaY;a.setBy({zoom:n/t*5}),!e.deltaX&&e.preventDefault()})},n.fold=function(){var e=this.ids,c=e.keyframesList,p=e.properties,f=e.values;e.propertiesAreas[1].addEventListener("click",function(e){var o=h(e.target,function(e){return m(e,"property")});if(o&&"0"!==o.getAttribute("data-object")){var s=p.length,l=p.indexOf(o);if(-1!==l){var d="1"===o.getAttribute("data-fold");!function e(n){var r=p[l],t=r.getAttribute("data-property"),a="1"===r.getAttribute("data-fold"),i="1"===r.getAttribute("data-object");if(o!==r&&(d?n||(x(c[l],"fold"),x(f[l],"fold"),x(r,"fold")):(g(c[l],"fold"),g(f[l],"fold"),g(r,"fold"))),i)for(++l;l<s;++l){if(!(-1<p[l].getAttribute("data-property").indexOf(t))){--l;break}e(!n&&a)}}(d),o.setAttribute("data-fold",d?"0":"1")}}})},n.setInputs=function(e){var n=this.ids.valuesArea;for(var r in e)n.querySelector('[data-property="'+r+'"] input').value=e[r]},n.drag=function(){var a=this,e=this.ids,i=e.scrollArea,o=e.timeArea,s=e.cursors,l=e.keyframesAreas,d=e.keyframesScrollAreas,c=this.scene;function p(e){var n=d[1].getBoundingClientRect(),r=n.width-30,t=n.left+15,a=Math.min(r,Math.max(e-t,0))/r,i=c.getDuration()*a;i=Math.ceil(20*i)/20,c.setTime(i)}c.on("animate",function(e){var n=e.time,r=Math.ceil(c.getDuration()),t="calc("+100*n/r+"% + "+(15-30*n/r)+"px)";a.setInputs(function e(n,r){for(var t in void 0===r&&(r={}),n){var a=n[t];if(y.isObject(a)){var i=e("Frame"===a.constructor.name?a.get():a);for(var o in i)r[t+"///"+o]=i[o]}else r[t]=a}return r}(e.frames)),o.innerHTML=n+"s",s.forEach(function(e){e.style.left=t})}),r.drag(s[0],{dragstart:function(e){e.inputEvent.stopPropagation()},drag:function(e){p(e.clientX)},container:window}),d.forEach(function(e){r.drag(e,{container:window,drag:function(e){var n=e.deltaX,r=e.deltaY,t=e.inputEvent;l[1].scrollLeft-=n,i.scrollTop-=r,t.preventDefault()},dragend:function(e){var n=e.isDrag,r=e.clientX,t=e.inputEvent;!n&&function(e,n){var r=h(e.target,function(e){return m(e,"keyframe")});r?c.setTime(r.getAttribute("data-time")):m(e.target,"keyframe_cursor")||p(n),e.preventDefault()}(t,r)}})})},e}()});
//# sourceMappingURL=timeline.min.js.map
